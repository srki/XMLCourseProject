/*

 Copyright 2008 The University of North Carolina at Chapel Hill

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License atthis

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 */
/*
 * Converts xml schemas to usable json objects, focused on elements and attributes.  Result is a javascript
 * object representing a starting node from the base schema, with recursive relations to all its children
 * and attributes.  The resulting structure can then be used or exported.
 *
 * Intended for populating forms rather than validation.  Not all restrictions are extracted at this time.
 *
 * Due to cross browser domain restrictions on ajax calls, the schema and its imports must all
 * be stored within the same domain as this script.
 *
 * @author Ben Pennell
 */
var Xsd2Json=function(){function e(e,i){var r={schemaURI:"",rootElement:null};this.options=$.extend({},r,i),this.xsdManager=new t(e,i)}function t(e,t){var i={rootElement:void 0,globalNamespaces:{}};this.options=$.extend({},i,t);var r=this;this.isHttpUrl=new RegExp(/^https?:\/\//),this.imports={},this.includes={},this.originatingSchema=null,this.originatingRoot=null,this.namespaceIndexes=[],this.xsNS="http://www.w3.org/2001/XMLSchema",this.globalNamespaces=$.extend({},t.globalNamespaces,{xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/",html:"http://www.w3.org/1999/xhtml/"}),$.each(this.globalNamespaces,function(e,t){r.registerNamespace(t)}),this.importSchema(this.computeSchemaLocation(e)),this.setOriginatingRoot(),this.resolveTypeReferences(this.originatingRoot),this.exportNamespaces()}function i(e,t,i,r){this.xsd=e,this.xsdManager=t,this.schemaUrl=i,this.schemaPath=this.schemaUrl.substring(0,this.schemaUrl.lastIndexOf("/")+1),this.rootDefinitions={},this.localNamespaces=$.extend({},this.xsdManager.globalNamespaces),this.xsPrefix="xs:",void 0!==r?(this.targetNSIndex=r,this.targetNS=this.xsdManager.getNamespaceUri(r)):(this.targetNS=null,this.targetNSIndex=null),this.root=null,this.extractNamespaces()}return e.prototype.getSchema=function(){var e=this;return function(){return e.xsdManager.originatingRoot}},e.prototype.stringify=function(e){if(null==this.xsdManager.originatingRoot)throw new Error("Root element was not set, cannot convert to JSON.");return e?vkbeautify.json(JSON.stringify(JSON.decycle(this.xsdManager.originatingRoot))):JSON.stringify(JSON.decycle(this.xsdManager.originatingRoot))},e.prototype.exportJSON=function(e,t,i){if(window.URL=window.webkitURL||window.URL,window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,void 0===window.BlobBuilder)return alert("Browser does not support saving files."),!1;var r=this.stringify(i);null!=t&&(r="var "+t+" = "+r+";");var n=new BlobBuilder;n.append(r);var s="application/json",a=document.createElement("a");a.download=e,a.href=window.URL.createObjectURL(n.getBlob(s)),a.dataset.downloadurl=[s,a.download,a.href].join(":"),a.target="exportJSON";var o=document.createEvent("MouseEvents");o.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null),a.dispatchEvent(o)},t.prototype.retrieveSchema=function(e,t){this.importAjax(e,t)},t.prototype.importAjax=function(e,t,i){var r=this,n=e.match(this.isHttpUrl),s=e;n&&!i&&(s=r.options.schemaURI+e.substring(e.lastIndexOf("/")+1)),$.ajax({url:s,dataType:"text",async:!1,success:function(i){var n=$.parseXML(i).documentElement;t.call(r,n,e)},error:function(){if(!n||i)throw new Error("Unable to import "+e);r.importAjax(e,t,!0)}})},t.prototype.computeSchemaLocation=function(e,t){if(!e)return null;var i=e.match(this.isHttpUrl);return i?e:t&&t.schemaPath?t.schemaPath+e:this.options.schemaURI?this.options.schemaURI+e:void 0},t.prototype.importSchema=function(e,t){t in this.imports||this.retrieveSchema(e,function(e,r){var n=new i(e,this,r);if(t)this.imports[t]=[n];else{if(n.targetNS in this.imports)return;this.imports[n.targetNS]=[n]}this.originatingSchema||(this.originatingSchema=n),this.processImports(n),this.processIncludes(n),n.processSchema()})},t.prototype.processImports=function(e){var t=e.getChildren(e.xsd,"import");for(var i in t){var r=t[i],n=(r.getAttribute("namespace"),this.computeSchemaLocation(r.getAttribute("schemaLocation"),e));this.importSchema(n,r.getAttribute("namespace"))}},t.prototype.includeSchema=function(e,t){if(t in this.includes){if(-1!=$.inArray(e,this.includes[t]))return;this.includes[t].push(e)}else this.includes[t]=[e];this.retrieveSchema(e,function(e,r){var n=new i(e,this,r,t);this.imports[this.getNamespaceUri(t)].push(n),this.processImports(n),this.processIncludes(n),n.processSchema()})},t.prototype.processIncludes=function(e){var t=e.getChildren(e.xsd,"include");for(var i in t){var r=t[i],n=this.computeSchemaLocation(r.getAttribute("schemaLocation"),e);this.includeSchema(n,e.targetNSIndex)}},t.prototype.setOriginatingRoot=function(){if(null!=this.options.rootElement){this.originatingRoot=this.originatingSchema.root;for(var e in this.originatingRoot.elements){var t=this.originatingRoot.elements[e];if(this.options.rootElement===t.name)return void(this.originatingRoot=t)}}else{this.originatingRoot={schema:!0,ns:this.originatingSchema.targetNSIndex,namespaces:[],elements:[],np:!0};for(var i in this.imports){var r=this.imports[i];for(var e in r){var n=r[e];for(var s in n.root.elements)this.originatingRoot.elements.push(n.root.elements[s])}}}},t.prototype.mergeRootLevelElements=function(){for(var e in this.imports){var t=this.imports[e];for(var i in t){var r=t[i];for(var n in r.root.elements)this.originatingRoot.elements.push(r.root.elements[n])}}},t.prototype.exportNamespaces=function(){var e=[];for(var t in this.namespaceIndexes){var i=this.namespaceIndexes[t];$.each(this.originatingSchema.localNamespaces,function(t,r){return r==i?(e.push({prefix:t,uri:r}),!1):void 0})}this.originatingRoot.namespaces=e},t.prototype.resolveTypeReferences=function(e){if(!e.np)return e;if(delete e.np,e.ref){var t=e.ref;delete e.ref;var i=this.resolveDefinition(t);if(!i)throw new Error("Could not resolve reference "+t+" from definition "+e.name);this.resolveTypeReferences(i),this.mergeRef(e,i)}else{var r=this;if(e.elements&&$.each(e.elements,function(){r.resolveTypeReferences(this)}),null!=e.attributes&&$.each(e.attributes,function(){r.resolveTypeReferences(this)}),e.typeRef){var n=e.typeRef;delete e.typeRef;for(var s in n){var a=n[s],o=this.resolveDefinition(a);if(!o)throw new Error("Could not resolve reference to type "+a+" from definition "+e.name);this.resolveTypeReferences(o),this.mergeType(e,o)}}}},t.prototype.resolveDefinition=function(e){var t=e.substring(0,e.indexOf(":")),i=this.imports[this.getNamespaceUri(t)];for(var t in i){var r=i[t];if(e in r.rootDefinitions){var n=r.rootDefinitions[e];if(null!=n)return n}}},t.prototype.resolveSchema=function(e,t){if(null!=t){var i=t.indexOf(":"),r=-1==i?"":t.substring(0,i),n=e.localNamespaces[r],s=this.imports[n];return null==s&&(s=[e]),s}return this},t.prototype.mergeType=function(e,t){for(var i in t)if(t.hasOwnProperty(i)){var r=t[i];null!=r&&null==e[i]?e[i]=r:$.isArray(r)&&$.isArray(t[i])&&(e[i]=e[i].concat(r))}},t.prototype.mergeRef=function(e,t){t.name&&(e.name=t.name),e.ns=t.ns,this.mergeType(e,t)},t.prototype.registerNamespace=function(e){var t=$.inArray(e,this.namespaceIndexes);return-1==t?(this.namespaceIndexes.push(e),this.namespaceIndexes.length-1):t},t.prototype.getNamespaceIndex=function(e){return $.inArray(e,this.namespaceIndexes)},t.prototype.getNamespaceUri=function(e){return this.namespaceIndexes[e]},i.prototype.processSchema=function(){this.root=this.build_schema(this.xsd)},i.prototype.extractNamespaces=function(){for(var e=0;e<this.xsd.attributes.length;e++){var t=this.xsd.attributes[e];if(t.specified){var i=t.nodeName.indexOf("xmlns");if(0==i){var r=t.nodeName.substring(5).replace(":",""),n=t.nodeValue;this.registerNamespace(n,r),t.nodeValue==this.xsdManager.xsNS&&(this.xsPrefix=r,""!=this.xsPrefix&&(this.xsPrefix=this.xsPrefix+":"))}}}if(!this.targetNS){this.targetNS=this.xsd.getAttribute("targetNamespace");var s=this.getLocalNamespacePrefix(this.targetNS);null==s&&(s=""),this.targetNSIndex=this.registerNamespace(this.targetNS,"")}""in this.localNamespaces||(this.localNamespaces[""]=this.targetNS)},i.prototype.createDefinition=function(e,t){if(!t){var i=e.getAttribute("name");i&&(t=this.extractName(i))}var r={values:[],type:null,ns:this.targetNSIndex,np:!0};return t&&t.localName&&(r.name=t.localName),"attribute"==e.localName?r.attribute=!0:("element"==e.localName&&(r.element=!0),r.attributes=[],r.elements=[]),r},i.prototype.addElement=function(e,t,i){if(!i.schema){var r=e.getAttribute("minOccurs"),n=e.getAttribute("maxOccurs");if(i&&(r||n)){var s=e.getAttribute("name")||e.getAttribute("ref"),a=this.extractName(s);"occurs"in i||(i.occurs={}),i.occurs[a.indexedName]={min:r,max:n}}}return null==i||"true"==e.getAttribute("abstract")||this.containsChild(i,t)||i.elements.push(t),t},i.prototype.addAttribute=function(e,t,i){null!=i&&i.attributes.push(t)},i.prototype.addReference=function(e,t){var i=this.extractName(t);e.ref=i.indexedName},i.prototype.addTypeReference=function(e,t){var i=this.extractName(t);e.typeRef||(e.typeRef=[]),e.typeRef.push(i.indexedName)},i.prototype.build_schema=function(e){var t={elements:[],ns:this.targetNSIndex,schema:!0,np:!0},i=this.getChildren(e);for(var r in i){var n=i[r];if("element"==n.localName){var s=this.buildTopLevel(n,t);this.addElement(n,s,t)}else("simpleType"==n.localName||"attribute"==n.localName||"complexType"==n.localName||"group"==n.localName||"attributeGroup"==n.localName)&&this.buildTopLevel(n,t)}return t},i.prototype.buildTopLevel=function(e){var t=e.getAttribute("name");if(t){var i=this.extractName(t),r=this.createDefinition(e,i);return this.rootDefinitions[i.indexedName]=r,this.build(e,r)}},i.prototype.build=function(e,t,i){return this["build_"+e.localName](e,t,i)},i.prototype.build_element=function(e,t,i){var r=e.getAttribute("ref"),n=e.getAttribute("substitutionGroup");if(r)this.addReference(t,r);else if(n)this.addTypeReference(t,n);else{var s=e.getAttribute("type");null==s?this.build(this.getChildren(e)[0],t):(t.type=this.getBuiltInType(s,t),null==t.type&&this.addTypeReference(t,s))}return t},i.prototype.build_attribute=function(e,t){var i=e.getAttribute("ref");if(i)this.addReference(t,i);else{var r=e.getAttribute("type");if(null==r){var n=this.getChildren(e)[0];n?this.build(this.getChildren(e)[0],t):t.type="string"}else t.type=this.getBuiltInType(r,t),null==t.type&&this.addTypeReference(t,r)}return t},i.prototype.build_complexType=function(e,t,i){"true"==e.getAttribute("mixed")&&(t.type="mixed");var r=this.getChildren(e);for(var n in r){var s=r[n];switch(s.localName){case"group":case"simpleContent":case"complexContent":case"choice":case"attributeGroup":case"sequence":case"all":case"anyAttribute":this.build(s,t);break;case"attribute":this.addAttribute(s,this.build_attribute(s,this.createDefinition(s)),t)}}},i.prototype.build_simpleType=function(e,t){var i=this.getChildren(e)[0];switch(i.localName){case"restriction":case"list":case"union":this.build(i,t)}},i.prototype.build_list=function(e,t){t.type=this.xsPrefix+"string",t.multivalued=!0},i.prototype.build_union=function(e,t){var i=e.getAttribute("memberTypes");if(i){i=i.split(" ");for(var r in i){var n=i[r];t.type=this.getBuiltInType(n,t),null==t.type&&this.addTypeReference(t,n)}}var s=this,a=this.getChildren(e,"simpleType");for(var r in a)s.build_simpleType(a[r],t)},i.prototype.build_group=function(e,t){var i=e.getAttribute("ref");if(i)return this.addTypeReference(t,i),t;var r=this.getChildren(e);for(var n in r){var s=r[n];switch(s.localName){case"choice":case"all":case"sequence":this.build(s,t)}}},i.prototype.build_all=function(e,t){var i=this.getChildren(e);for(var r in i){var n=i[r];"element"==n.localName&&this.addElement(n,this.build_element(n,this.createDefinition(n)),t)}},i.prototype.build_choice=function(e,t){var i=e.getAttribute("maxOccurs"),r={elements:[],minOccurs:e.getAttribute("minOccurs"),maxOccurs:null==i||isNaN(i)&&"unbounded"!=i||0>i?1:i},n=this.getChildren(e);for(var s in n){var a=n[s];switch(a.localName){case"choice":case"group":case"sequence":case"any":this.build(a,t);break;case"element":var o=this.addElement(a,this.build_element(a,this.createDefinition(a)),t);o.name?r.elements.push(o.ns+":"+o.name):r.elements.push(o.ref)}}"choices"in t||(t.choices=[]),t.choices.push(r)},i.prototype.build_sequence=function(e,t){var i=this.getChildren(e);for(var r in i){var n=i[r];switch(n.localName){case"choice":case"group":case"sequence":case"any":this.build(n,t);break;case"element":this.addElement(n,this.build_element(n,this.createDefinition(n)),t)}}},i.prototype.build_any=function(e,t){t.any=!("0"==e.getAttribute("minOccurs")&&"0"==e.getAttribute("maxOccurs"))},i.prototype.build_anyAttribute=function(e,t){t.anyAttribute=!0},i.prototype.build_complexContent=function(e,t){"true"==e.getAttribute("mixed")&&(t.type="mixed");var i=this.getChildren(e)[0];switch(i.localName){case"extension":case"restriction":this.build(i,t)}},i.prototype.build_simpleContent=function(e,t){var i=this.getChildren(e)[0];switch(i.localName){case"extension":case"restriction":this.build(i,t)}},i.prototype.build_restriction=function(e,t){var i=e.getAttribute("base");t.type=this.getBuiltInType(i,t),null==t.type&&this.addTypeReference(t,i);var r=this.getChildren(e);for(var n in r){var s=r[n];switch(s.localName){case"group":case"simpleType":case"choice":case"attributeGroup":case"sequence":case"all":case"anyAttribute":this.build(s,t);break;case"attribute":this.addAttribute(s,this.build_attribute(s,this.createDefinition(s)),t);break;case"enumeration":t.values.push(s.getAttribute("value"))}}},i.prototype.build_extension=function(e,t){var i=e.getAttribute("base");t.type=this.getBuiltInType(i,t),null==t.type&&this.addTypeReference(t,i);var r=this.getChildren(e);for(var n in r){var s=r[n];switch(s.localName){case"group":case"choice":case"attributeGroup":case"sequence":case"all":case"anyAttribute":this.build(s,t);break;case"attribute":this.addAttribute(s,this.build_attribute(s,this.createDefinition(s)),t)}}},i.prototype.build_attributeGroup=function(e,t){var i=e.getAttribute("ref");if(i)return this.addTypeReference(t,i),t;var r=this.getChildren(e);for(var n in r){var s=r[n];switch(s.localName){case"attributeGroup":case"anyAttribute":this.build(s,t);break;case"attribute":this.addAttribute(s,this.build_attribute(s,this.createDefinition(s)),t)}}},i.prototype.getBuiltInType=function(e,t){if(null!=t.type)return t.type;if(-1==e.indexOf(":")){if(""==this.xsPrefix)return e}else if(0==e.indexOf(this.xsPrefix))return e.substring(this.xsPrefix.length);return null},i.prototype.getChildren=function(e,t,i){var r=[];e||(e=this.xsd);var n=void 0!==t,s=void 0!==i,a=e.childNodes;for(var o in a){var c=a[o];1!=c.nodeType||c.namespaceURI!=this.xsdManager.xsNS||!(n&&c.localName==t||!n&&"annotation"!=c.localName)||s&&c.getAttribute("name")!=i||r.push(c)}return r},i.prototype.containsChild=function(e,t){if(e.elements){var i=t.ref||t.ns+":"+t.name;for(var r in e.elements){var n=e.elements[r],s=n.ref||n.ns+":"+n.name;if(i==s)return!0}}return!1},i.prototype.extractName=function(e){if(!e)return null;var t={},i=e.indexOf(":");return-1==i?(t.localName=e,t.prefix=""):(t.localName=e.substring(i+1),t.prefix=e.substring(0,i)),t.namespace=this.xsdManager.getNamespaceIndex(this.localNamespaces[t.prefix]),t.indexedName=t.namespace+":"+t.localName,t},i.prototype.registerNamespace=function(e,t){var i=this.xsdManager.registerNamespace(e);return void 0!==t&&(this.localNamespaces[t]=e),i},i.prototype.getLocalNamespacePrefix=function(e){for(var t in this.localNamespaces)if(this.localNamespaces[t]==e)return t;return null},e}.call();