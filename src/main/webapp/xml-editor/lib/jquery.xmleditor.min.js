/*

 Copyright 2008 The University of North Carolina at Chapel Hill

 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.

 */
!function(e){function t(e,t){this.editor=t,this.guiEditor=this.editor.guiEditor,this.objectType=e,this.domNodeID=null,this.domNode=null,this.parentElement=null,this.textInput=null}function i(e,t,i,n,o,s){this.menuID=e,this.menuContent=null,this.enabled=n,this.owner=o,this.editor=s,this.label=t,this.expanded=i}function n(e,t,i,n,o,s){l.call(this,e,t,i,n,o,s)}function o(e,t){this.baseXML=e,this.xml=null,this.changeState=0,this.editor=t,this.schemaTree=this.editor.schemaTree,this.domParser=null,window.DOMParser&&(this.domParser=new DOMParser),this.setXMLFromString(this.baseXML),this.namespaces=new c}function s(e){return e.replace(/[<>&"']/g,function(e){return Y[e]})}function a(t,i,n){var o=t.childNodes,r=null,d="",l=!1,h="",c="";for(var u in o){var m=o[u];switch(m.nodeType){case 1:var p="",f="";l||9!=t.nodeType&&(f=i+"  ",p="\n"),h+=p+a(m,f,n),l=!1;break;case 3:var x=m.nodeValue;e.trim(x)?(h+=d+s(x),d="",l=!0):d=x;break;case 4:l||9!=t.nodeType&&(h+="\n"+i+"  "),h+="<![CDATA["+m.nodeValue+"]]>";break;case 8:l||9!=t.nodeType&&(h+="\n"+i+"  "),h+="<!--"+s(m.nodeValue)+"-->"}r=m}var b=t.attributes;if(b)for(var g=/^xmlns:?(.*)$/,v=!1,u=0;u<b.length;u++)v&&(c+="\n"+i+"   ",v=!1),c+=" "+b[u].nodeName+'="'+s(b[u].nodeValue)+'"',g.test(b[u].nodeName)&&(v=!0);if(1==t.nodeType){if(h){var y=l?"":"\n"+i;return i+"<"+t.nodeName+c+">"+h+y+"</"+t.nodeName+">"}return i+"<"+t.nodeName+c+" />"}return h}function r(e){this.editor=e,this.guiContent=null,this.xmlContent=null,this.elementIndex=0,this.rootElement=null,this.active=!1}function d(t){this.editor=t,this.menuBarContainer=null,this.parentElement=null,this.updateFunctions=[];var i=this,n=null;e.each(i.editor.submitButtonConfigs,function(e,t){return t.url?(n=t,!1):void 0}),this.headerMenuData=[{label:"File",enabled:!0,action:function(e){i.activateMenu(e)},items:[{label:"Submit to Server",enabled:null!=n,binding:"ctrl+alt+s",action:function(){i.editor.uploadXML.call(i.editor,n)}},{label:"Export",enabled:void 0!==typeof Blob,binding:"ctrl+alt+e",action:e.proxy(i.editor.exportXML,i.editor)}]},{label:"Edit",enabled:!0,action:function(e){i.activateMenu(e)},items:[{label:"Undo",enabled:!1,binding:"ctrl+z or mac+z",action:function(){i.editor.undoHistory.changeHead(-1)}},{label:"Redo",enabled:!1,binding:"ctrl+y or mac+shift+z",action:function(){i.editor.undoHistory.changeHead(1)}},{label:"Delete",enabled:!0,binding:"del",action:function(){i.editor.guiEditor.deleteSelected()}},{label:"Move Element Up",enabled:!0,binding:"alt+up",action:function(){i.editor.guiEditor.moveSelected(!0)}},{label:"Move Element Down",enabled:!0,binding:"alt+down",action:function(){i.editor.guiEditor.moveSelected()}}]},{label:"Select",enabled:!0,action:function(e){i.activateMenu(e)},items:[{label:"Deselect",enabled:!0,binding:"esc",action:function(){i.editor.guiEditor.deselect()}},{label:"Next Element",enabled:!0,binding:"down",action:function(){i.editor.guiEditor.selectNext()}},{label:"Previous Element",enabled:!0,binding:"up",action:function(){i.editor.guiEditor.selectNext(!0)}},{label:"Next Attribute",enabled:!0,binding:"right",action:function(){i.editor.guiEditor.selectAttribute()}},{label:"Previous Attribute",enabled:!0,binding:"left",action:function(){i.editor.guiEditor.selectAttribute(!0)}},{label:"Parent",enabled:!0,binding:"shift+left",action:function(){i.editor.guiEditor.selectParent()}},{label:"First Child",enabled:!0,binding:"shift+right",action:function(){i.editor.guiEditor.selectParent(!0)}},{label:"Next Sibling",enabled:!0,binding:"shift+down",action:function(){i.editor.guiEditor.selectSibling()}},{label:"Previous Sibling",enabled:!0,binding:"shift+up",action:function(){i.editor.guiEditor.selectSibling(!0)}}]},{label:"Insert",enabled:!0,action:function(e){i.activateMenu(e)},items:[{label:"Add attribute",enabled:!0,binding:"alt+a",action:function(){var e=i.editor.guiEditor.selectedElement;e instanceof v&&i.editor.addNode(e,"attribute",!1)}},{label:"Add element",enabled:!0,binding:"enter",action:function(){var e=i.editor.guiEditor.selectedElement;e instanceof v&&i.editor.addNextElement(e,!1)}},{label:"Add child element",enabled:!0,binding:"alt+e",action:function(){var e=i.editor.guiEditor.selectedElement;e instanceof v&&i.editor.addNode(e,"element",!1)}},{label:"Add sibling element",enabled:!0,binding:"alt+s",action:function(){var e=i.editor.guiEditor.selectedElement;e&&i.editor.addNode(e.parentElement,"element",!1,e)}},{label:"Add element to parent",enabled:!0,binding:"alt+p",action:function(){var e=i.editor.guiEditor.selectedElement;e&&i.editor.addNode(e.parentElement,"element",!1)}},{label:"Add element to root",enabled:!0,binding:"alt+r",action:function(){i.editor.addNode(i.editor.guiEditor.rootElement,"element",!1)}},{label:"Add text to element",enabled:!0,binding:"alt+t",action:function(){var e=i.editor.guiEditor.selectedElement;e&&i.editor.addNode(e,"text",!1)}},{label:"Add comment to element",enabled:!0,binding:"alt+/",action:function(){var e=i.editor.guiEditor.selectedElement;e&&i.editor.addNode(e,"comment",!1)}},{label:"Add CDATA to element",enabled:!0,binding:"alt+,",action:function(){var e=i.editor.guiEditor.selectedElement;e&&i.editor.addNode(e,"cdata",!1)}}]},{label:"View",enabled:!0,action:function(e){i.activateMenu(e)},items:[{label:"Switch to XML View",enabled:!0,binding:"ctrl+alt+1",action:function(){i.editor.modeChange(0)}},{label:"Switch to Text View",enabled:!0,binding:"ctrl+alt+2",action:function(){i.editor.modeChange(1)}}]},{label:"Options",enabled:!0,action:function(e){i.activateMenu(e)},items:[{label:"Pretty XML Formatting",enabled:!0,checked:i.editor.options.prettyXML,action:function(){i.editor.options.prettyXML=!i.editor.options.prettyXML,i.checkEntry(this,i.editor.options.prettyXML)}},{label:"Enable shortcut keys",enabled:!0,checked:i.editor.options.enableGUIKeybindings,action:function(){i.editor.setEnableKeybindings(!i.editor.options.enableGUIKeybindings),i.checkEntry(this,i.editor.options.enableGUIKeybindings)}},{label:"Enforce min/max occurs",enabled:i.editor.options.enforceOccurs,checked:i.editor.options.enforceOccurs,action:function(){i.editor.options.enforceOccurs=!i.editor.options.enforceOccurs,i.editor.modifyMenu.refreshContextualMenus(),i.checkEntry(this,i.editor.options.enforceOccurs)}},{label:"Prepend new elements",enabled:!0,checked:i.editor.options.prependNewElements,action:function(){i.editor.options.prependNewElements=!i.editor.options.prependNewElements,i.checkEntry(this,i.editor.options.prependNewElements)}}]},{label:i.editor.options.xmlEditorLabel,enabled:!0,itemClass:"header_mode_tab",action:function(){i.editor.modeChange(0)}},{label:i.editor.options.textEditorLabel,enabled:!0,itemClass:"header_mode_tab",action:function(){i.editor.modeChange(1)}}]}function l(e,t,i,n,o,s,a){this.menuID=e,this.label=t,this.menuHeader=null,this.menuContent=null,this.enabled=n,this.expanded=i,this.getRelativeToFunction=a,this.target=null,this.owner=o,this.editor=s}function h(e){this.editor=e,this.menus={},this.menuColumn=null,this.menuContainer=null}function c(t){if(this.namespaceURIs={},this.namespaceToPrefix={},t){e.extend({},t);var i=this;e.each(this.namespaces,function(){i.namespaceToPrefix[value]=key})}}function u(e){this.nameToDef={},this.rootElement=e,this.namespaceIndexes=this.rootElement.namespaces,this.namespaces=new c;for(var t in this.namespaceIndexes){var i=this.namespaceIndexes[t];this.namespaces.addNamespace(i.uri,i.prefix)}}function m(e){this.editor=e,this.aceEditor=null,this.state=0,this.xmlEditorDiv=null,this.xmlContent=null,this.selectedTagRange=null,this.resetSelectedTagRange(),this.active=!1,this.tagRegex=/<(([a-zA-Z0-9\-]+:)?([a-zA-Z0-9\-]+))( |\/|>|$)/}function p(e,t){this.xmlState=e,this.editor=t,this.states=[],this.headIndex=-1,this.stateChangeEvent=null,this.stateCaptureEvent=null,this.disabled="undefined"==typeof document.implementation.createDocument}function f(e,i,n){t.call(this,e,n),this.xmlElement=i,this.attributeInput=null,this.addButton=null;var o;this.attributeName=e.localName,this.xmlElement.objectType.namespace!=this.objectType.namespace&&(o=this.editor.xmlState.getNamespacePrefix(this.objectType.namespace),this.attributeName=o+this.attributeName)}function x(e,t){this.objectType={attrStub:!0},this.editor=t,this.guiEditor=this.editor.guiEditor,this.elementHeader=null,this.tagName="",this.xmlElement=e,this.nameInput=null}function b(e,t){var i={cdata:!0,type:"cdata"};E.call(this,e,i,t),this.objectType=i}function g(e,t){var i={comment:!0,type:"comment"};E.call(this,e,i,t),this.objectType=i}function v(i,n,o){t.call(this,n,o),this.xmlNode=e(i),this.isRootElement=this.xmlNode[0].parentNode===this.xmlNode[0].ownerDocument,this.isTopLevel=this.xmlNode[0].parentNode.parentNode===this.xmlNode[0].ownerDocument,this.allowChildren=this.objectType.elements.length>0||this.objectType.any,this.allowAttributes=this.objectType.anyAttribute||this.objectType.attributes&&this.objectType.attributes.length>0,this.allowText=null!=this.objectType.type,this.elementHeader=null,this.nodeContainer=null,this.nodeCount=0,this.attributeContainer=null,this.attributeCount=0,this.presentChildren={},this.choiceCount=[]}function y(e){this.objectType={elementStub:!0},this.editor=e,this.guiEditor=this.editor.guiEditor,this.elementHeader=null,this.nameInput=null,this.tagName=""}function C(t,i,n){var o=this,s=!1;t.keydown(function(i){if(27==i.keyCode){if(s&&e(t.xml_autocomplete("widget")).is(":visible"))t.xml_autocomplete("close");else{o.remove(),o.guiEditor.selectNode(o.parentElement);var n=o.parentElement?o.parentElement:o.xmlElement;n.updated({action:"childRemoved",target:o})}return!1}return 13==i.keyCode?(o.create(),!1):32==i.keyCode?!1:void((i.which>=37&&i.which<=40||46==i.which)&&i.stopPropagation())});var a=!1;t.focus(function(e){if(!a&&i&&i.length>0){var r=[],d=o.editor.xmlState;for(var l in i){var h=i[l];r.push(d.getNamespacePrefix(h.namespace)+h.localName)}t.xml_autocomplete({source:r,minLength:0,delay:0,matchSize:t,validItemFunction:n,select:function(e,t){o.nameInput.text(t.item.value),o.create()}}),s=!0,a=!0}s&&t.xml_autocomplete("search",t.text()),e.stopPropagation()}).mousedown(function(e){t.focus(),e.stopPropagation()})}function N(e){this.template_path=e.options.templateOptions.templatePath,this.templates=e.options.templateOptions.templates,this.editor=e,this.extension_regx=/\.\w{3,}$/}function E(i,n,o,s){var a={text:!0,type:n};this.textNode=i,this.xmlNode=e(i),this.vocabulary=s,t.call(this,a,o)}function T(i,n){var o={element:!0,type:"mixed"};t.call(this,o,n),this.xmlNode=e(i),this.isRootElement=this.xmlNode[0].parentNode===this.xmlNode[0].ownerDocument,this.isTopLevel=this.xmlNode[0].parentNode.parentNode===this.xmlNode[0].ownerDocument,this.allowChildren=!0,this.allowAttributes=!0,this.allowText=!0,this.elementHeader=null,this.nodeContainer=null,this.tagName=""}var w="xml_menu_container",S="menu_header",_="xml_menu_column",I="menu_content",M=180,A="xml_element",j="xml_text_node",D="xml_node",P="top_level_element_group",H="attribute_container",R="xml_attrs",O="xml_header_item_",k="xml_editor_container",U="xml_work_area",L="add_top_menu",B="add_attribute_menu",z="add_element_menu",X="add_node_menu",F="xml_menu_bar",V="send_xml",K="xml_submit_status",W="xml_content",q="xml_tab_area",G="xml_problems_panel",$="gui_content",J="text_content",Q="xml_editor_header",Z=function(e){var t=e.localName;if(t)return t;var i=e.nodeName.indexOf(":");return-1==i?e.nodeName:e.nodeName.substring(i+1)};e.widget("xml.xmlEditor",{options:{schema:null,loadSchemaAsychronously:!0,libPath:null,ajaxOptions:{xmlUploadPath:null,xmlRetrievalPath:null,xmlRetrievalParams:null},templateOptions:{templatePath:!1,templates:[],cancelFunction:!1},submitResponseHandler:null,submitErrorHandler:null,submitButtonConfigs:null,elementUpdated:void 0,documentTitle:null,addTopMenuHeaderText:"Add Top Element",addAttrMenuHeaderText:"Add Attribute",addElementMenuHeaderText:"Add Subelement",xmlEditorLabel:"XML",textEditorLabel:"Text",enableDocumentStatusPanel:!0,documentStatusPanelDomId:"<div>",confirmExitWhenUnsubmitted:!0,enableGUIKeybindings:!0,floatingMenu:!0,expandingTextAreas:!0,prettyXML:!0,undoHistorySize:20,menuEntries:void 0,enforceOccurs:!1,prependNewElements:!1,autocomplete:!0,targetNS:null},_create:function(){var t=this.options.schema,i=this.options.libPath;this.instanceNumber=e("xml-xmlEditor").length,this.schemaTree=null,this.xmlState=null,this.xmlEditorContainer=null,this.xmlWorkAreaContainer=null,this.xmlTabContainer=null,this.editorHeader=null,this.problemsPanel=null,this.guiEditor=null,this.textEditor=null,this.activeEditor=null,this.undoHistory=null,this.menuBar=null,this.modifyMenu=null,this.isTextAreaEditor=!1;var n=document.location.href,o=n.lastIndexOf("/");if(-1!=o&&(this.baseUrl=n.substring(0,o+1)),e.isFunction(e.fn.autosize)||(this.options.expandingTextAreas=!1),"function"!=typeof this.options.schema){var s=/^https?:\/\/.*?\//,a=this.baseUrl.match(s);i?(i=/\/$/.test(i)?i:i+"/",s.test(i)?this.libPath=i:0===i.indexOf("/")?this.libPath=a[0]+i.substr(1,i.length):this.libPath=this.baseUrl+i):this.libPath=this.baseUrl+"lib/",("string"==typeof t||typeof t instanceof String)&&(s.test(t)||(0===t.indexOf("/")?this.options.schema=a[0]+t.substr(1,t.length):this.options.schema=this.baseUrl+t))}this.loadSchema(this.options.schema)},_init:function(){if(this.options.submitButtonConfigs)this.submitButtonConfigs=this.options.submitButtonConfigs;else{var t=!this.options.ajaxOptions.xmlUploadPath;this.submitButtonConfigs=[{url:this.options.ajaxOptions.xmlUploadPath,label:t?"Export":"Submit changes",onSubmit:t?this.exportXML:null,disabled:void 0===typeof Blob&&t}]}null==this.options.submitErrorHandler&&(this.options.submitErrorHandler=function(e,t){0===e.status?alert("Not connect.\n Verify Network."):404==e.status?alert("Requested page not found. [404]"):500==e.status?alert("Internal Server Error [500]."):"parsererror"===t?alert("Requested JSON parse failed."):"timeout"===t?alert("Time out error."):"abort"===t?alert("Ajax request aborted."):alert("Uncaught Error.\n"+e.responseText)});var i=null;this.element.is("textarea")?(this.isTextAreaEditor=!0,i=this.element.text(),this.xmlEditorContainer=e("<div/>").attr("class",k),e(this.element).before(this.xmlEditorContainer).hide()):(i=this.element.children().length>0?this.element.html():this.element.text(),this.element.text(""),this.xmlEditorContainer=e("<div/>").attr("class",k).appendTo(this.element)),this.xmlState=null,this.xmlWorkAreaContainer=null,this.xmlTabContainer=null,this.editorHeader=null,this.problemsPanel=null,this.guiEditor=new r(this),this.textEditor=new m(this),this.activeEditor=this.guiEditor;var n=this;this.menuBar=new d(this),this.menuBar.updateFunctions.push(this.refreshMenuUndo),this.menuBar.updateFunctions.push(this.refreshMenuSelected),this.options.menuEntries&&e.each(this.options.menuEntries,function(){n.menuBar.addEntry(this)}),this.modifyMenu=new h(this),this.options.confirmExitWhenUnsubmitted&&e(window).bind("beforeunload",function(e){return null!=n.xmlState&&n.xmlState.isChanged()?"The document contains unsaved changes.":void 0}),this.loadVocabularies(this.options.vocabularyConfigs),this.loadDocument(this.options.ajaxOptions,i)},loadSchema:function(t){var i=this;if(jQuery.isFunction(t))this.schema=t.apply(),i._schemaReady();else if(this.options.loadSchemaAsychronously&&!window.MSBlobBuilder&&"undefined"!=typeof window.URL&&"undefined"!=typeof Worker&&"undefined"!=typeof Blob){var n=new Blob(["self.onmessage = function(e) {importScripts(e.data.libPath + 'cycle.js');var schema;if (typeof e.data.schema == 'string' || typeof e.data.schema instanceof String) {	var xmlhttp = new XMLHttpRequest();	xmlhttp.onreadystatechange = function() {		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {			schema = eval('(' + xmlhttp.responseText + ')');			self.postMessage(JSON.retrocycle(schema));		}	};	xmlhttp.open('GET', e.data.schema, true);	xmlhttp.send();} else {	schema = JSON.retrocycle(e.data.schema);	self.postMessage(schema);}}"],{type:"text/javascript"}),o=new Worker(window.URL.createObjectURL(n));o.onmessage=function(e){i.schema=e.data,i._schemaReady(),o.terminate()},o.onerror=function(e){i.schema=JSON.retrocycle(t),i._schemaReady()},o.postMessage({schema:t,libPath:this.libPath})}else"string"==typeof t||typeof t instanceof String?e.ajax({url:t,async:i.options.loadSchemaAsynchronously,dataType:"json",success:function(e){i.schema=JSON.retrocycle(e),i._schemaReady()}}):(i.schema=JSON.retrocycle(t),i._schemaReady())},loadDocument:function(t,i){var n=this;null!=t&&null!=t.xmlRetrievalPath?e.ajax({type:"GET",url:t.xmlRetrievalPath,data:t.xmlRetrievalParams,dataType:"text",success:function(t){e(t).children().length?n._documentReady(t):n.options.templateOptions.templatePath?n._templating():console.error("Could not specified document and no fallback provided, cannot start.")}}):e.trim(i)?this._documentReady(i):this.options.templateOptions.templatePath?this._templating():console.error("No starting document")},loadVocabularies:function(t){var i=this;this.loadingVocabs=0,this.options.vocabularyConfigs&&this.options.vocabularyConfigs.vocabularies&&(e.each(this.options.vocabularyConfigs.vocabularies,function(e,t){"url"in t&&i.loadingVocabs++}),e.each(this.options.vocabularyConfigs.vocabularies,function(t,n){"url"in n&&e.ajax({url:n.url,type:"GET",dataType:"json"}).done(function(e){n.values=e,i.loadingVocabs--,0==i.loadingVocabs&&i._everythingReady()})}))},_templating:function(){var e=this;e.template=new N(e),e.template.createChooseTemplate()},_documentReady:function(e){var t=this;this.xmlState=new o(e,this),this.xmlState.extractNamespacePrefixes(),this.undoHistory=new p(this.xmlState,this),this.undoHistory.setStateChangeEvent(function(){t.refreshDisplay()}),this._everythingReady()},_schemaReady:function(){this.options.targetNS||(this.targetNS=this.schema.namespace),this.schemaTree=new u(this.schema),this.schemaTree.build(),this._everythingReady()},_everythingReady:function(){this.schemaTree&&this.xmlState&&0==this.loadingVocabs&&(this.targetPrefix=this.xmlState.namespaces.getNamespacePrefix(this.options.targetNS),this.constructEditor(),this.refreshDisplay(),this.activeEditor.selectRoot(),this.undoHistory.captureSnapshot())},constructEditor:function(){this.xmlWorkAreaContainer=e("<div/>").attr("class",U).appendTo(this.xmlEditorContainer);var t=e("<div/>").addClass(Q+"_backing").appendTo(this.xmlWorkAreaContainer);this.editorHeader=e("<div/>").attr("class",Q).appendTo(this.xmlWorkAreaContainer),null!=this.options.documentTitle&&e("<h2/>").html("Editing Description: "+this.options.documentTitle).appendTo(this.editorHeader),this.menuBar.render(this.editorHeader),t.height(this.editorHeader.outerHeight()),this.editorHeaderGroup=this.editorHeader.add(t),this.xmlTabContainer=e("<div/>").attr("class",q).css("padding-top",this.editorHeader.height()+"px").appendTo(this.xmlWorkAreaContainer),this.problemsPanel=e("<pre/>").attr("class",G).hide().appendTo(this.xmlTabContainer),this.guiEditor.initialize(this.xmlTabContainer),this.modeChange(0);var i=this;e(window).resize(e.proxy(this.resize,this)),this.modifyMenu.initialize(this.xmlEditorContainer),this.modifyMenu.addMenu(z,this.options.addElementMenuHeaderText,!0,!1,!0),this.modifyMenu.addAttributeMenu(B,this.options.addAttrMenuHeaderText,!0,!1,!0),this.modifyMenu.addNodeMenu(X,"Add Nodes",!0,!1),this.addTopLevelMenu=this.modifyMenu.addMenu(L,this.options.addTopMenuHeaderText,!0,!0,!1,function(e){var t=i.guiEditor.selectedElement;if(!t||0==t.length||t.isRootElement)return null;for(var n=t;null!=n.parentElement&&!n.parentElement.isRootElement;)n=n.parentElement;return null!=n?n:null}).populate(this.guiEditor.rootElement),this.setEnableKeybindings(this.options.enableGUIKeybindings),this.options.floatingMenu&&e(window).bind("scroll",e.proxy(this.modifyMenu.setMenuPosition,this.modifyMenu)),this.ready=!0},resize:function(){this.xmlTabContainer.width(this.xmlEditorContainer.outerWidth()-this.modifyMenu.menuColumn.outerWidth()),null!=this.activeEditor&&this.activeEditor.resize(),this.editorHeader.width(this.xmlTabContainer.width()),this.options.floatingMenu&&this.modifyMenu.setMenuPosition()},addChildElementCallback:function(t,i,n){if(!e(t).hasClass("disabled")){var o=e(t).data("xml").target,s=e(t).data("xml").objectType;this.addChildElement(o,s,i,n)}},addChildElement:function(e,t,i,n){if(!e.allowChildren)return null;if(this.textEditor.active&&this.xmlState.changesNotSynced())try{this.setXMLFromEditor()}catch(o){return void this.addProblem("Unable to add element, please fix existing XML syntax first.",o)}var s;if("string"==typeof t||t instanceof String){var a=e.objectType.elements;for(var r in a){var d=a[r],l=this.xmlState.getNamespacePrefix(d.namespace)+d.localName;if(l==t){s=d;break}}if(!s&&!e.objectType.any)return"Could not add child "+t+", it is not a valid child of "+e.objectType.localName}else s=t;var h;if(s){if(!e.childCanBeAdded(s))return;this.xmlState.addNamespace(s),h=e.addElement(s,i,n)}else{var c=t.split(":");this.xmlState.addNamespace(c.length>1?c[0]:""),h=e.addNonschemaElement(t,i,n)}return null==h?"Failed to add child of type "+t:(this.activeEditor.addElementEvent(e,h),h)},addAttributeButtonCallback:function(t){if(!e(t).hasClass("disabled")){var i=e(t).data("xml");return this.addAttribute(i.target,i.objectType,t)}},addAttribute:function(t,i,n){if(this.xmlState.changesNotSynced())try{this.setXMLFromEditor()}catch(o){return void alert(o.message)}var s;if("object"===e.type(i))s=i;else{var a=t.objectType.attributes;for(var r in a){var d=a[r],l=this.xmlState.getNamespacePrefix(d.namespace)+d.localName;if(l==i){s=d;break}}if(!s&&!t.objectType.anyAttribute)return"Could not add attribute "+i+", it is not a valid for element "+t.objectType.localName}var h;if(s)this.xmlState.addNamespace(s),h=t.addAttribute(s);else{var c=i.split(":");c.length>1&&this.xmlState.addNamespace(c[0]),h=t.addAttribute({attribute:!0,localName:i})}return this.activeEditor.addAttributeEvent(t,h,e(n)),h},addNodeCallback:function(t,i,n){if(!e(t).hasClass("disabled")){var o=e(t).data("xml");this.addNode(o.target,i,n)}},addNode:function(e,t,i,n){if(this.xmlState.changesNotSynced())try{this.setXMLFromEditor()}catch(o){return void alert(o.message)}if(e instanceof v){var s=e.addNode(t,i,n);s&&(this.guiEditor.selectNode(s),this.activeEditor.addNodeEvent(e,s),s.focus())}},addNextElement:function(e,t){e.allowChildren?this.addNode(e,"element",t):this.addNode(e.parentElement,"element",t,e)},documentLoadedEvent:function(e){null!=this.guiEditor&&null!=this.guiEditor.rootElement&&(this.guiEditor.rootElement.xmlNode=e.children().first()),null!=this.problemsPanel&&this.clearProblemPanel()},modeChange:function(t){return 0==t&&this.guiEditor.active||1==t&&this.textEditor.active?this:(0==t&&(e("*:focus").blur(),e(".xml_editor_container *:focus").blur(),this.textEditor.isInitialized()&&this.xmlState.isChanged()&&(this.setXMLFromEditor(),this.undoHistory.captureSnapshot())),e(".active_mode_tab").removeClass("active_mode_tab"),this.modifyMenu.clearContextualMenus(),null!=this.activeEditor&&this.activeEditor.deactivate(),0==t?(this.activeEditor=this.guiEditor,e("#"+O+this.options.xmlEditorLabel.replace(/ /g,"_")).addClass("active_mode_tab")):(this.activeEditor=this.textEditor,e("#"+O+this.options.textEditorLabel.replace(/ /g,"_")).addClass("active_mode_tab")),this.activeEditor.activate(),this.ready&&this.resize(),this)},refreshDisplay:function(){null!=this.activeEditor&&(this.activeEditor.refreshDisplay(),this.options.floatingMenu&&this.modifyMenu.setMenuPosition(),this.xmlWorkAreaContainer.width(this.xmlEditorContainer.outerWidth()-this.modifyMenu.menuColumn.outerWidth()))},setTextArea:function(e){this.isTextAreaEditor&&this.element.val(e)},setXMLFromEditor:function(){var e=this.textEditor.aceEditor.getValue();this.xmlState.setXMLFromString(e),this.guiEditor.isActive&&(this.guiEditor.setRootElement(this.xmlState.xml.children()[0]),this.addTopLevelMenu.populate(this.guiEditor.rootElement))},submitXML:function(e){e.onSubmit&&e.onSubmit.call(this,e),e.url&&this.uploadXML(e)},exportXML:function(){if("undefined"==typeof Blob)return this.addProblem("Browser does not support saving files via this editor.  To save, copy and paste the document from the Text view."),!1;var t=e("<form><input type='text' class='xml_export_filename' placeholder='file.xml'/><input type='submit' value='Export'/></form>").dialog({modal:!0,dialogClass:"xml_dialog",resizable:!1,title:"Enter file name",height:80}),i=this;t.submit(function(){if(i.textEditor.active)try{i.setXMLFromEditor()}catch(n){return i.xmlState.setDocumentHasChanged(!0),e("."+K).html("Failed to save<br/>See errors at top").css("background-color","#ffbbbb").animate({backgroundColor:"#ffffff"},1e3),i.addProblem("Cannot save due to invalid xml",n),!1}var o=i.xml2Str(i.xmlState.xml),s=new Blob([o],{type:"text/xml"}),a=URL.createObjectURL(s);t.dialog("option","title","");var r=t.find('input[type="text"]').val();r||(r="file.xml");var d=e("<a>Download "+r+"</a>").attr("href",a);return d.attr("download",r),t.empty().append(d),!1})},uploadXML:function(t){if(!t||!t.url){if(!(this.submitButtonConfigs.length>0&&this.submitButtonConfigs[0].url))return void this.addProblem("Cannot submit because no post Options");t=this.submitButtonConfigs[0]}if(this.textEditor.active)try{this.setXMLFromEditor()}catch(i){return this.xmlState.setDocumentHasChanged(!0),e("."+K).html("Failed to submit<br/>See errors at top").css("background-color","#ffbbbb").animate({backgroundColor:"#ffffff"},1e3),this.addProblem("Cannot submit due to invalid xml",i),!1}var n=this.xml2Str(this.xmlState.xml);e("."+K).html("Submitting...");var o=this;e.ajax({url:t.url,contentType:"application/xml",type:"POST",data:n,success:function(i){var n=t.responseHandler(i);n?(o.xmlState.syncedChangeEvent(),e("."+K).html("Failed to submit<br/>See errors at top").css("background-color","#ffbbbb").animate({backgroundColor:"#ffffff"},1e3),o.addProblem("Failed to submit xml document",n)):(o.xmlState.changesCommittedEvent(),o.clearProblemPanel())},error:function(e,i){return t.errorHandler?void t.errorHandler(e,i):void o.options.submitErrorHandler(e,i)}})},swordSubmitResponseHandler:function(t){var i=e(t);return i.length>0&&"sword:error"==Z(i[i.length-1])?i.find("atom\\:summary").html():!1},xml2Str:function(e){null==e&&(e=this.xmlState.xml);var t=e instanceof jQuery?e[0]:e;if(this.options.prettyXML)return a(t);try{return(new XMLSerializer).serializeToString(t)}catch(i){try{return t.xml}catch(i){return this.addProblem("Xmlserializer not supported",i),!1}}},addProblem:function(e,t){this.problemsPanel.html(e+"<br/>"),void 0!==t&&(t.substring?this.problemsPanel.append(t.replace(/</g,"&lt;").replace(/>/g,"&gt;")):this.problemsPanel.append(t.message.replace(/</g,"&lt;").replace(/>/g,"&gt;"))),console.error(t),this.refreshProblemPanel()},clearProblemPanel:function(){this.problemsPanel.hide()},refreshProblemPanel:function(){""==this.problemsPanel.html()?this.problemsPanel.hide("fast"):this.problemsPanel.show("fast")},nsEquals:function(e,t,i){return t.substring?t==Z(e)&&i==e.namespaceURI:Z(t)==Z(e)&&e.namespaceURI==t.namespace},stripPrefix:function(e){var t=e.indexOf(":");return-1==t?e:e.substring(t+1)},setEnableKeybindings:function(t){t?(this.options.enableGUIKeybindings=!0,this.menuBar.menuBarContainer.removeClass("xml_bindings_disabled"),e(window).on("keydown.xml_keybindings",e.proxy(this.keydownCallback,this))):(this.options.enableGUIKeybindings=!1,this.menuBar.menuBarContainer.addClass("xml_bindings_disabled"),e(window).off("keydown.xml_keybindings"))},getFocusedInput:function(){return e("input:focus, textarea:focus, select:focus")},keydownCallback:function(t){var i=this.options.prependNewElements^t.shiftKey;if(this.guiEditor.active){var n=this.getFocusedInput();if(27==t.which)return n.length>0?n.blur():this.guiEditor.selectNode(null),!1;if(9==t.which)return t.preventDefault(),this.guiEditor.focusInput(t.shiftKey),!1;if(46==t.which&&0==n.length)return this.guiEditor.deleteSelected(),!1;if(t.which>36&&t.which<41)return t.altKey&&(0==n.length||n.is("textarea"))?(t.preventDefault(),this.guiEditor.moveSelected(38==t.which),n.is("textarea")&&n.focus(),!1):(0==n.length&&(t.preventDefault(),t.shiftKey?40==t.which||38==t.which?this.guiEditor.selectSibling(38==t.which):(37==t.which||39==t.which)&&this.guiEditor.selectParent(39==t.which):40==t.which||38==t.which?this.guiEditor.selectNext(38==t.which):(37==t.which||39==t.which)&&this.guiEditor.selectAttribute(37==t.which)),!0);if((t.metaKey||t.ctrlKey)&&0==n.length&&t.which=="Z".charCodeAt(0))return this.undoHistory.changeHead(t.shiftKey?1:-1),!1;if((t.metaKey||t.ctrlKey)&&0==n.length&&t.which=="Y".charCodeAt(0))return this.undoHistory.changeHead(1),!1}if(t.altKey&&t.ctrlKey){if(t.which=="S".charCodeAt(0))return e("."+V).click(),!1;if(t.which=="E".charCodeAt(0))return this.exportXML(),!1;if(t.which=="1".charCodeAt(0))return this.modeChange(0),!1;if(t.which=="2".charCodeAt(0))return this.modeChange(1),!1}if(this.guiEditor.active){var o=this.guiEditor.selectedElement;if(13==t.which){var n=this.getFocusedInput();return 0==n.length||t.altKey?(o instanceof v?this.addNextElement(o,t.shiftKey):(o instanceof y||o instanceof x)&&o.create(),t.preventDefault(),!1):!0}if(t.altKey){if(t.which=="E".charCodeAt(0))return o instanceof v&&o.allowChildren&&this.addNode(o,"element",i),!1;if(t.which=="S".charCodeAt(0))return o&&this.addNode(o.parentElement,"element",i,o),!1;if(t.which=="P".charCodeAt(0))return o&&o.parentElement.objectType&&this.addNode(o.parentElement,"element",i),!1;if(t.which=="R".charCodeAt(0))return this.addNode(this.guiEditor.rootElement,"element",i),!1;if(t.which=="A".charCodeAt(0))return o&&this.addNode(o,"attribute",i),!1;if(t.which=="T".charCodeAt(0))return o&&this.addNode(o,"text",i),!1;if(191==t.which)return o&&this.addNode(o,"comment",i),!1;if(188==t.which)return o&&this.addNode(o,"cdata",i),!1}}return!0},refreshMenuUndo:function(t){t.undoHistory.headIndex>0?e("#"+O+"Undo").removeClass("disabled").data("menuItemData").enabled=!0:e("#"+O+"Undo").addClass("disabled").data("menuItemData").enabled=!1,t.undoHistory.headIndex<t.undoHistory.states.length-1?e("#"+O+"Redo").removeClass("disabled").data("menuItemData").enabled=!0:e("#"+O+"Redo").addClass("disabled").data("menuItemData").enabled=!1},refreshMenuSelected:function(t){var i=["Deselect","Next_Element","Previous_Element","Parent","First_Child","Next_Sibling","Previous_Sibling","Next_Attribute","Previous_Attribute","Delete","Move_Element_Up","Move_Element_Down"],n=null!=t.guiEditor.selectedElement&&t.guiEditor.active;e.each(i,function(){n?e("#"+O+this.toString()).removeClass("disabled").data("menuItemData").enabled=!0:e("#"+O+this.toString()).addClass("disabled").data("menuItemData").enabled=!1})},getVocabulary:function(t){if(!this.options.vocabularyConfigs)return null;var i=this,n=null,o=this.xmlState.xml;this.options.vocabularyConfigs.cssSelectors&&e.each(this.options.vocabularyConfigs.cssSelectors,function(i,s){for(var a=e(i,o),r=0;r<a.length;r++)if(t.xmlNode[0]===a[r])return n=s,!1});var s=function(e){return i.options.vocabularyConfigs.xpathNamespaces[e]||null};return s.lookupNamespaceURI=s,this.options.vocabularyConfigs.xpathSelectors&&e.each(this.options.vocabularyConfigs.xpathSelectors,function(e,i){for(var a=o[0].evaluate(e,o[0],s,null,null),r=a.iterateNext();r;){if(t.xmlNode[0]===r)return n=i,!1;r=a.iterateNext()}}),n&&n in this.options.vocabularyConfigs.vocabularies?this.options.vocabularyConfigs.vocabularies[n]:null}}),t.prototype.createElementInput=function(t,i,n){void 0===i&&(i="");var o=null,s=null;if(this.objectType.values&&this.objectType.values.length>0){var a=this.objectType.values;o=document.createElement("select"),o.id=t,o.className="xml_select",n.appendChild(o);for(var r in a){var d=a[r],l=new Option(d.toString(),d);o.options[r]=l,i==d&&(o.options[r].selected=!0)}(" "==i||""==i)&&(o.selectedIndex=-1),s=e(o)}else if(this.objectType.text&&("string"==this.objectType.type||"mixed"==this.objectType.type)||this.objectType.attribute||this.objectType.cdata||this.objectType.comment){
    o=document.createElement("textarea"),o.id=t,o.className="xml_textarea",o.value=i?i:" ",n.appendChild(o),s=e(o);var h=this;s.one("focus",function(){h.editor.options.expandingTextAreas&&s.autosize()," "==this.value&&(this.value="")})}else"date"==this.objectType.type?(o=document.createElement("input"),o.type="date",o.id=t,o.className="xml_date",o.value=i?i:"",n.appendChild(o),s=e(o)):this.objectType.type&&(o=document.createElement("input"),"date"==this.objectType.type?(o.type="date",o.className="xml_date"):"dateTime"==this.objectType.type?(o.type="datetime",o.className="xml_datetime"):(o.type="text",o.className="xml_input"),o.id=t,o.value=i?i:"",n.appendChild(o),s=e(o));return s},t.prototype.focus=function(){null!=this.domNode&&this.guiEditor.focusObject(this.domNode),this.textInput&&this.textInput.focus()},t.prototype.getDomNode=function(){return this.domNode},t.prototype.remove=function(){this.xmlNode.remove(),null!=this.domNode&&this.domNode.remove()},t.prototype.swap=function(e){null!=e&&(e.xmlNode.detach().insertAfter(this.xmlNode),null!=e.domNode&&null!=this.domNode&&e.domNode.detach().insertAfter(this.domNode))},t.prototype.moveUp=function(){var e=this.domNode.prev("."+D);return e.length>0?(this.swap(e.data("xmlObject")),!0):!1},t.prototype.moveDown=function(){var e=this.domNode.next("."+D);return e.length>0?(e.data("xmlObject").swap(this),!0):!1},t.prototype.select=function(){this.domNode.addClass("selected")},t.prototype.isSelected=function(){return this.domNode.hasClass("selected")},i.prototype.constructor=i,i.prototype=Object.create(l.prototype),i.prototype.destroy=function(){null!=this.menuContent&&this.menuContent.remove()},i.prototype.initEventHandlers=function(){var t=this;this.menuContent.on("click","li",function(i){var n=t.editor.options.prependNewElements;i.shiftKey&&(n=!n),t.owner.editor.addNodeCallback(this,e(this).data("xml").nodeType,n)})},i.prototype.populate=function(t){this.expanded&&this.menuContent.css("height","auto");var i=this.menuContent.outerHeight();if(this.menuContent.empty(),!(this.editor.guiEditor.active&&t instanceof v))return this.menuHeader.addClass("disabled"),void(this.enabled=!1);if(t.allowChildren&&e("<li>Add Element</li>").data("xml",{target:t,nodeType:"element"}).appendTo(this.menuContent),t.allowAttributes&&e("<li>Add Attribute</li>").data("xml",{target:t,nodeType:"attribute"}).appendTo(this.menuContent),e("<li>Add CDATA</li>").data("xml",{target:t,nodeType:"cdata"}).appendTo(this.menuContent),e("<li>Add comment</li>").data("xml",{target:t,nodeType:"comment"}).appendTo(this.menuContent),null!=t.objectType.type&&t.allowText&&(this.addButton=e("<li>Add text</li>").attr({title:"Add text"}).data("xml",{target:t,nodeType:"text"}).appendTo(this.menuContent)),this.expanded){var n=this.menuContent.outerHeight();0==n&&(n=1),this.menuContent.css({height:i+"px"}).stop().animate({height:n+"px"},M).show()}return 0==this.menuContent.children().length?(this.menuHeader.addClass("disabled"),this.enabled=!1):(this.menuHeader.removeClass("disabled"),this.enabled=!0),this},i.prototype.clear=function(){this.menuContent.hide()},n.prototype.constructor=n,n.prototype=Object.create(l.prototype),n.prototype.initEventHandlers=function(){var e=this;this.menuContent.on("click","li",function(t){e.owner.editor.addAttributeButtonCallback(this)})},n.prototype.populate=function(t){if(null!=t&&(null==this.target||null==t.domNode||this.target[0]!==t.domNode[0])){this.expanded&&this.menuContent.css("height","auto");var i=this.menuContent.outerHeight();this.menuContent.empty(),this.target=t;var n=this.target.objectType.attributes;if(n){var o={};e(this.target.xmlNode[0].attributes).each(function(){var i=this;e.each(n,function(){this.name==i.nodeName&&(o[this.name]=e("#"+t.domNodeID+"_"+i.nodeName.replace(":","-")))})});var s=this;e.each(this.target.objectType.attributes,function(){var i=this,n=s.editor.xmlState.getNamespacePrefix(i.namespace),a=n+i.localName,r=e("<li/>").attr({title:"Add "+a,id:t.domNodeID+"_"+a.replace(":","_")+"_add"}).html(a).data("xml",{objectType:i,target:t}).appendTo(s.menuContent);i.name in o&&(r.addClass("disabled"),o[i.name].length>0&&(o[i.name].data("xmlAttribute").addButton=r))})}if(this.expanded){var a=this.menuContent.outerHeight();0==a&&(a=1),this.menuContent.css({height:i+"px"}).stop().animate({height:a+"px"},M).show()}return 0==this.menuContent.children().length?(this.menuHeader.addClass("disabled"),this.enabled=!1):(this.menuHeader.removeClass("disabled"),this.enabled=!0),this}},o.prototype.isChanged=function(){return this.changeState>1},o.prototype.isBaseDocument=function(){return 0==this.changeState},o.prototype.changesSaved=function(){return 1==this.changeState},o.prototype.changesSynced=function(){return 2==this.changeState},o.prototype.changesNotSynced=function(){return 3==this.changeState},o.prototype.documentChangedEvent=function(){if(this.changeState=2,this.editor.undoHistory.captureSnapshot(),this.updateStateMessage(),this.editor.isTextAreaEditor){var e=this.editor.xml2Str(this.xml);this.editor.setTextArea(e)}},o.prototype.changesCommittedEvent=function(){this.changeState=1,this.updateStateMessage()},o.prototype.changeEvent=function(){this.changeState<2&&(this.changeState=2),this.updateStateMessage()},o.prototype.syncedChangeEvent=function(){this.changeState=2,this.updateStateMessage()},o.prototype.unsyncedChangeEvent=function(){this.changeState=3,this.updateStateMessage()},o.prototype.updateStateMessage=function(){this.isChanged()?e("."+K).html("Unsaved changes"):e("."+K).html("All changes saved")},o.prototype.addNamespace=function(e,t){if(null!=e||t){var i;if("object"==typeof e?(t=e.namespace,i=this.editor.schemaTree.namespaces.namespaceToPrefix[t]):i=e,!this.namespaces.containsURI(t)){var n=this.namespaces.containsPrefix(i),o=i;if(null==i||t){if(t&&(null==i||n)){i||(o="ns");for(var s=0;o in this.namespaces.namespaceURIs;)o=i+ ++s}}else t=("urn:ns:local:xxxxxx-"+((new Date).getTime()%16777216).toString(16)).replace(/x/g,function(e){return(16*Math.random()|0).toString(16)});var a=this.xml[0].documentElement;a.setAttributeNS?a.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns"+(o?":":"")+o,t):a.setAttribute("xmlns:"+o,t),this.namespaces.addNamespace(t,o)}}},o.prototype.extractNamespacePrefixes=function(){var t=null,i=this.xml.children()[0].attributes,n=this;e.each(i,function(){var e=this.name,i=this.value;0==e.indexOf("xmlns")&&(t=(prefixIndex=e.indexOf(":"))>0?e.substring(prefixIndex+1):"",n.namespaces.addNamespace(i,t))})},o.prototype.getNamespacePrefix=function(e){var t=this.namespaces.getNamespacePrefix(e);return void 0===t&&(t=this.editor.schemaTree.namespaces.getNamespacePrefix(e)),t},o.prototype.getIEXMLParser=function(){for(var e=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.3.0","Microsoft.XMLDOM"],t=0;t<e.length;t++)try{var i=new ActiveXObject(e[t]);return i}catch(n){}return null},o.prototype.setXMLFromString=function(t){var i,n=t.indexOf("<?XML:NAMESPACE");if(-1!=n&&(n=t.indexOf("/>",n),t=t.substring(n+2)),this.domParser){i=this.domParser.parseFromString(t,"application/xml");var o=i.getElementsByTagName("parsererror");if(o.length>0)throw new Error(e(o).text())}else if(i=this.getIEXMLParser(),i.async=!1,i.loadXML(t),0!=i.parseError.errorCode)throw new Error("Error in line "+i.parseError.line+" position "+i.parseError.linePos+"\nError Code: "+i.parseError.errorCode+"\nError Reason: "+i.parseError.reason+"Error Line: "+i.parseError.srcText);this.xml=e(i),this.editor.documentLoadedEvent(this.xml)};var Y={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"};r.prototype.initialize=function(i){return this.xmlContent=e("<div class='"+W+"'/>"),this.xmlContent.data("xml",{}),this.placeholder=e("<div/>").attr("class","placeholder").html("There are no elements in this document.  Use the menu on the right to add new top level elements.").appendTo(this.xmlContent),this.guiContent=e("<div/>").attr({id:$+this.editor.instanceNumber,"class":$}).appendTo(i),this.guiContent.append(this.xmlContent),this.documentElement=new t(null,this.editor),this.documentElement.domNode=this.xmlContent,this.documentElement.nodeContainer=this.xmlContent,this.documentElement.placeholder=this.placeholder,this.setRootElement(this.editor.xmlState.xml.children()[0],!1),this._initEventBindings(),this},r.prototype.setRootElement=function(e,t){var i=this.editor.schemaTree.getElementDefinition(e);null==i&&(i=this.editor.schemaTree.rootElement),this.rootElement=new v(e,i,this.editor),(t||1==arguments.length)&&this.rootElement.render(this.documentElement,!0)},r.prototype._initEventBindings=function(){var t=this;this.xmlContent.on("click","."+H,function(t){e(this).data("xmlAttribute").select(),t.stopPropagation()}).on("click","."+H+" > a:not(.create_attr)",function(i){var n=e(this).parents("."+H).eq(0).data("xmlAttribute");n.remove(),n.xmlElement.updated({action:"attributeRemoved",target:n}),t.editor.xmlState.documentChangedEvent(),i.stopPropagation()}).on("change","."+H+" > input,."+H+" > textarea,."+H+" > select",function(i){var n=e(this).parents("."+H).eq(0).data("xmlAttribute");n.syncValue(),n.xmlElement.updated({action:"attributeSynced",target:n}),t.editor.xmlState.documentChangedEvent()}),this.xmlContent.on("click","."+D,function(e){t.selectNode(this),e.stopPropagation()}).on("click",".move_up",function(i){t.moveNode(e(this).parents("."+A).eq(0).data("xmlObject"),!0),i.stopPropagation()}).on("click",".move_down",function(i){t.moveNode(e(this).parents("."+A).eq(0).data("xmlObject")),i.stopPropagation()}).on("click","."+j+" .xml_delete",function(i){t.deleteText(e(this).parents("."+j).eq(0).data("xmlObject")),i.stopPropagation()}).on("click",".top_actions .xml_delete",function(i){t.deleteElement(e(this).parents("."+A).eq(0).data("xmlObject")),i.stopPropagation()}).on("click",".toggle_collapse",function(t){return e(this).parents("."+A).first().data("xmlObject").toggleCollapsed(),void t.stopPropagation()}).on("change",".element_text",function(i){var n=e(this),o=n.parents("."+A).eq(0).data("xmlObject"),s=n.parents(".xml_node").first().data("xmlObject");s&&(s.syncText(),o.updated({action:"valueSynced"}),t.editor.xmlState.documentChangedEvent())}).on("focus",".xml_text_node .xml_textarea",function(t){var i=e(this).parents(".xml_node").first().data("xmlObject");i.select(),t.stopPropagation()}).on("click",".xml_text_node",function(t){var i=e(this).data("xmlObject");i.select(),t.stopPropagation()})},r.prototype.selectRoot=function(){this.selectNode(e("."+A).first())},r.prototype.activate=function(){return this.active=!0,this.deselect(),this.editor.textEditor.resetSelectedTagRange(),(this.editor.textEditor.isModified()||this.editor.textEditor.isInitialized()&&this.editor.xmlState.isChanged())&&(this.editor.refreshDisplay(),this.editor.textEditor.setInitialized()),this.guiContent.show(),this.selectRoot(),this},r.prototype.deactivate=function(){return this.active=!1,this.guiContent.hide(),this},r.prototype.nextIndex=function(){return A+ ++this.elementIndex},r.prototype.clearElements=function(){return e("."+P).remove(),this},r.prototype.resize=function(){return this},r.prototype.refreshDisplay=function(){return this.deselect(),this.elementIndex=0,this.rootElement.xmlNode=this.editor.xmlState.xml.children().first(),this.refreshElements(),this},r.prototype.refreshElements=function(){var e=this.documentElement.getDomNode();e.empty(),e=e[0];var t=e.parentNode,i=document.createDocumentFragment();return i.appendChild(e),this.rootElement.render(this.documentElement,!0),this.editor.addTopLevelMenu.populate(this.rootElement),t.appendChild(i),this},r.prototype.addElementEvent=function(e,t){e.domNodeID!=this.xmlContent.attr("id")&&e.updated({action:"childAdded",target:t});this.editor;this.focusObject(t.domNode),this.selectNode(t),this.focusSelectedText(t),e==this.rootElement&&this.editor.addTopLevelMenu.populate(this.rootElement),this.editor.xmlState.documentChangedEvent(),this.editor.resize()},r.prototype.addAttributeEvent=function(e,t,i){e.updated({action:"attributeAdded",target:t.objectType.name}),this.focusObject(t.domNode),t.select(),i.addClass("disabled"),t.addButton=i,this.editor.xmlState.documentChangedEvent(),this.editor.resize()},r.prototype.addNodeEvent=function(e,t){e.updated({action:t.objectType.type+"Added",target:e}),this.focusObject(t.domNode),this.editor.xmlState.documentChangedEvent(),this.editor.resize()},r.prototype.select=function(e){var t=e.closest("."+H+",."+D);t.is("."+H)?t.data("xmlAttribute").select():this.selectNode(e)},r.prototype.selectNode=function(t){if(t&&0!=t.length){e(".selected").removeClass("selected");var i;if(t instanceof Element||t instanceof jQuery){var n=e(t);i=n.is("."+D)?n.data("xmlObject"):n.closest("."+D).data("xmlObject")}else i=t;this.selectedNode=i,this.selectedElement=i,this.selectedNode.select(),i instanceof v?e("*:focus").blur():i instanceof y||(this.selectedElement=i.parentElement,this.selectedNode.domNode.addClass("selected")),this.editor.modifyMenu.refreshContextualMenus(this.selectedElement)}else this.deselect();return this},r.prototype.deselect=function(){var t=e("."+H+".selected");return t.length>0?(t.removeClass("selected"),this):(e("."+D+".selected").removeClass("selected"),this.selectedNode=null,this.selectedElement=null,null!=this.editor.modifyMenu&&this.editor.modifyMenu.clearContextualMenus(),this)},r.prototype.deleteSelected=function(){if(null==this.selectedNode)return this;try{var e=this.selectedNode.getSelectedAttribute();if(e.length>0){this.selectAttribute(!0);var t=e.prev("."+H);0==t.length&&(t=e.next("."+H)),t.addClass("selected");var i=e.data("xmlAttribute");return i.remove(),this}}catch(n){}return this.selectedNode instanceof v?this.deleteElement(this.selectedNode):this.deleteText(this.selectedNode),this},r.prototype.deleteElement=function(e){var t=e.parentElement;e.objectType.localName;if(t&&t instanceof v&&t.childCanBeRemoved(e.objectType)){t.childRemoved(e);var i=e.isSelected();return i?this.selectNode(this.afterDeleteSelection(e)):t.isSelected&&t!=this.rootElement&&this.editor.modifyMenu.refreshContextualMenus(t),t==this.rootElement&&this.editor.addTopLevelMenu.populate(this.rootElement),e.remove(),t.updated({action:"childRemoved",target:e}),this.editor.xmlState.documentChangedEvent(),this}},r.prototype.deleteText=function(e){var t=e.isSelected();return t&&this.selectNode(this.afterDeleteSelection(e)),e.remove(),e.parentElement.updated({action:"textRemoved",target:e}),this.editor.xmlState.documentChangedEvent(),this},r.prototype.afterDeleteSelection=function(e){var t=e.domNode.next("."+D);return 0==t.length&&(t=e.domNode.prev("."+D)),0==t.length&&(t=e.domNode.parent().closest("."+D)),t},r.prototype.moveSelected=function(t){var i=e(".selected."+j);return i.length>0?this.moveNode(i.data("xmlObject"),t):this.moveNode(this.selectedNode,t)},r.prototype.moveNode=function(e,t){if(null==e)return this;var i=t?e.moveUp():e.moveDown();return i&&(this.editor.xmlState.documentChangedEvent(),e.focus()),this},r.prototype.updateElementPosition=function(e){var t=e.data("xmlObject");if(t.xmlNode){var i=e.prev("."+D);0==i.length?(i=e.next("."+D),t.xmlNode.detach().insertBefore(i.data("xmlObject").xmlNode)):t.xmlNode.detach().insertAfter(i.data("xmlObject").xmlNode),this.editor.xmlState.documentChangedEvent()}this.selectNode(e)},r.prototype.selectSibling=function(t){var i=t?"prev":"next";return this.selectedNode.domNode.length>0?(newSelection=this.selectedNode.domNode[i]("."+A),0!=newSelection.length||this.selectedNode.isTopLevel||this.selectedNode.domNode.parents("."+A).each(function(){return newSelection=e(this)[i]("."+A),newSelection.length>0||e(this).data("xmlObject").isTopLevel?!1:void 0})):t||(newSelection=e("."+A).first()),0==newSelection.length?this:(this.selectNode(newSelection.first()).selectedNode.focus(),this)},r.prototype.selectParent=function(e){return e?newSelection=this.selectedNode.domNode.find("."+A):newSelection=this.selectedNode.domNode.parents("."+A),0==newSelection.length?this:(this.selectNode(newSelection.first()).selectedNode.focus(),this)},r.prototype.selectNext=function(t){var i=null;if(null==this.selectedNode)t||(i=e("."+A).first());else{var n=!1,o=e("."+A+":visible",this.xmlContent);t&&(o=e(o.get().reverse()));var s=this.selectedNode;s instanceof v||(s=s.parentElement),o.each(function(){return n?(i=e(this),!1):void(this.id==s.domNodeID&&(n=!0))})}return null!=i&&this.selectNode(i.first()).selectedNode.focus(),this},r.prototype.selectAttribute=function(t){if(null==this.selectedNode)return this;if(this.selectedNode instanceof v){var i=this.selectedNode.getSelectedAttribute();if(i.length>0){var n=i[t?"prev":"next"]("."+H);n.length>0&&(e("."+H+".selected").removeClass("selected"),n.addClass("selected"))}else this.selectedNode.domNode&&(i=this.selectedNode.attributeContainer.children("."+H).first(),i.addClass("selected"))}},r.prototype.focusSelectedText=function(){if(null==this.selectedNode)return this;var e=null;if(e=null!=this.selectedNode.textInput?this.selectedNode.textInput.focus():this.selectedNode.domNode.find("input[type=text].element_text:visible, textarea.element_text:visible, select.element_text:visible").first().focus(),null==e||0==e.length)return this;var t=e.parents("."+A);return t!==this.selectedNode&&this.selectNode(t),e.focus(),this},r.prototype.focusInput=function(t){var i=e("input:focus, textarea:focus, select:focus, .edit_title:focus");if(0==i.length&&null==this.selectedNode){if(t)return this;i=this.xmlContent.find("input[type=text]:visible, textarea:visible, select:visible, .edit_title:visible").first().focus()}else{var n=!1,o="input[type=text]:visible, textarea:visible, select:visible, .edit_title:visible";null!=this.selectedNode&&0==i.length&&(o+=", ."+A,i=this.selectedNode.domNode);var s=this.xmlContent.find(o);t&&(s=e(s.get().reverse())),s.each(function(){return n&&!e(this).hasClass(A)?(i=e(this).focus(),!1):void(this===i.get(0)&&(n=!0))})}return this.select(i),this},r.prototype.isCompletelyOnScreen=function(t){var i=t.offset().top,n=i+t.height(),o=e(window).scrollTop()+this.editor.editorHeader.height(),s=o+e(window).height()-this.editor.editorHeader.height();return i>o&&s>n},r.prototype.focusObject=function(t){if(!this.isCompletelyOnScreen(t)){var i=t.offset().top+t.height()/2-e(window).height()/2;i>t.offset().top&&(i=t.offset().top),i-=this.editor.editorHeader.height(),e("html, body").stop().animate({scrollTop:i},500)}},d.prototype.activateMenu=function(t){if(this.menuBarContainer.hasClass("active"))return void this.menuBarContainer.removeClass("active");var i=this;e.each(this.updateFunctions,function(){this(i.editor)}),this.menuBarContainer.addClass("active"),e("html").one("click",function(){i.menuBarContainer.removeClass("active")}),t.stopPropagation()},d.prototype.render=function(t){this.parentElement=t,this.menuBarContainer=e("<div/>").addClass(F).appendTo(t),this.headerMenu=e("<ul/>"),this.menuBarContainer.append(this.headerMenu),this.initEventHandlers();var i=this;e.each(this.headerMenuData,function(){i.generateMenuItem(this,i.headerMenu)})},d.prototype.initEventHandlers=function(){this.headerMenu.on("click","li",{menuBar:this},function(t){var i=e(this).data("menuItemData");i.enabled&&"[object Function]"==Object.prototype.toString.call(i.action)&&i.action.call(this,t)})},d.prototype.generateMenuItem=function(t,i){var n=e("<li/>").appendTo(i),o=(e("<span/>").addClass("xml_menu_check").appendTo(n),e("<a/>").appendTo(n).html("<span>"+t.label+"</span>"));t.binding&&o.append("<span class='binding'>"+t.binding+"</span>"),null!=t.action&&"[object Function]"!=Object.prototype.toString.call(t.action)&&o.attr({href:t.action,target:"_blank"}),t.enabled||n.addClass("disabled"),t.itemClass&&n.addClass(t.itemClass);var s=this;if(n.data("menuItemData",t).attr("id",O+t.label.replace(/ /g,"_")),void 0!==t.items&&t.items.length>0){var a=e("<ul/>").addClass("sub_menu").appendTo(n);e.each(t.items,function(){s.generateMenuItem(this,a)})}t.checked&&this.checkEntry(n,!0)},d.prototype.addEntry=function(t){var i=this.headerMenuData;t.insertPath&&e.each(t.insertPath,function(){var t=this;e.each(i,function(){return this.label==t?(i=this.items,!1):void 0})}),i&&(delete t.insertPath,i.push(t))},d.prototype.checkEntry=function(t,i){var t=e(t),n=t.data("menuItemData");n.checked=i,i?t.find(".xml_menu_check").html("&#x2713;"):t.find(".xml_menu_check").html("")},l.prototype.destroy=function(){null!=this.menuHeader&&this.menuHeader.remove(),null!=this.menuContent&&this.menuContent.remove()},l.prototype.render=function(t){this.menuHeader=e("<div class='"+S+"'/>").appendTo(t),this.expanded?this.menuHeader.html(this.label+" <span>&#9660;</span>"):this.menuHeader.html(this.label+" <span>&#9654;</span>"),this.enabled||this.menuHeader.addClass("disabled"),this.menuContent=e("<ul id='"+this.menuID+"' class='"+I+"'/>").data("menuData",this).appendTo(t);var i=this;return this.menuHeader.click(function(){i.enabled&&(i.expanded?(i.menuContent.animate({height:"hide"},M,null,function(){i.menuContent.hide()}),i.menuHeader.html(i.label+" <span>&#9654;</span>"),i.expanded=!1):(i.menuContent.show(),i.menuContent.animate({height:"show"},M),i.menuHeader.html(i.label+" <span>&#9660;</span>"),i.expanded=!0))}),this},l.prototype.initEventHandlers=function(){var t=this;this.menuContent.on("click","li",function(i){var n=t.getRelativeToFunction?t.getRelativeToFunction(e(this).data("xml").target):null,o=t.editor.options.prependNewElements;i.shiftKey&&(o=!o),t.owner.editor.addChildElementCallback(this,n,o)})},l.prototype.clear=function(){var e=this.menuContent.height();return this.menuContent.empty(),this.menuContent.css({height:e+"px"}).stop().animate({height:"0px"},M),this.target=null,this.enabled=!1,this.menuHeader.addClass("disabled"),this},l.prototype.populate=function(t){if(null!=t&&(null==this.target||null==t.domNode||this.target[0]!==t.domNode[0])){this.expanded&&this.menuContent.css("height","auto");var i=this.menuContent.outerHeight();this.menuContent.empty(),this.target=t;var n=this,o=this.target;o.objectType.choices;if(this.target.objectType.elements&&e.each(this.target.objectType.elements,function(){var t=this,i=n.editor.xmlState.getNamespacePrefix(t.namespace)+t.localName,s=e("<li/>").attr({title:"Add "+i}).html(i).data("xml",{target:n.target,objectType:t}).appendTo(n.menuContent);o.childCanBeAdded(t)||s.addClass("disabled")}),this.target.objectType.any&&e.each(this.editor.guiEditor.rootElement.objectType.elements,function(){var t=this,i=n.editor.xmlState.getNamespacePrefix(t.namespace)+t.localName;e("<li/>").attr({title:"Add "+i}).html(i).data("xml",{target:n.target,objectType:t}).appendTo(n.menuContent)}),this.expanded){var s=this.menuContent.outerHeight()+1;0==s&&(s=1),this.menuContent.css({height:i+"px"}).stop().animate({height:s+"px"},M).show()}return 0==this.menuContent.children().length?(this.menuHeader.addClass("disabled"),this.enabled=!1):(this.menuHeader.removeClass("disabled"),this.enabled=!0),this}},h.prototype.initialize=function(t){if(this.menuColumn=e("<div/>").attr("class",_).appendTo(t),this.editor.options.enableDocumentStatusPanel){var i=this,n=e(i.editor.options.documentStatusPanelDomId);e("<span/>").addClass(K).html("Document is unchanged").appendTo(n),null!=i.editor.submitButtonConfigs&&e.each(i.editor.submitButtonConfigs,function(t,o){var s;s=o.id&&"createDomElement"in o&&!o.createDomElement?e("#"+o.id):e("<input/>").attr({id:o.id,type:"button","class":o.cssClass||V,name:o.name||"submit",value:o.label||"Submit"}).appendTo(n),"responseHandler"in o||!o.url||(o.responseHandler=o.responseHandler=i.editor.options.submitResponseHandler||i.editor.swordSubmitResponseHandler),s.click(function(){i.editor.submitXML(o)})}),n.appendTo(this.menuColumn)}return this.menuContainer=e("<div class='"+w+"'/>").appendTo(this.menuColumn),this.menuContainer.css({"max-height":e(window).height(),"overflow-y":"auto"}),this},h.prototype.addMenu=function(e,t,i,n,o,s){var a=new l(e,t,i,n,this,this.editor,s);return this.menus[e]={menu:a,contextual:o},a.render(this.menuContainer),a.initEventHandlers(),a},h.prototype.addAttributeMenu=function(e,t,i,o,s){4==arguments.length&&(s=!1);var a=new n(e,t,i,o,this,this.editor);return this.menus[e]={menu:a,contextual:s},a.render(this.menuContainer),a.initEventHandlers(),a},h.prototype.addNodeMenu=function(e,t,n,o){var s=new i(e,t,n,o,this,this.editor);return this.menus[e]={menu:s,contextual:!0},s.render(this.menuContainer),s.initEventHandlers(),s},h.prototype.clearContextualMenus=function(){return e.each(this.menus,function(){this.contextual&&this.menu.clear()}),this.setMenuPosition(),this},h.prototype.refreshContextualMenus=function(t){if(void 0===t){if(!this.targetElement)return this;t=this.targetElement}else this.targetElement=t;return e.each(this.menus,function(){this.contextual&&this.menu.populate(t)}),this.setMenuPosition(),this},h.prototype.setMenuPosition=function(){if(null!=this.menuColumn&&null!=this.menuColumn.offset()){var t=this.editor.xmlWorkAreaContainer,i=this.editor.xmlEditorContainer,n=t.offset().top;e(window).scrollTop()>=n?(this.menuColumn.css({position:"fixed",left:i.offset().left+i.outerWidth()-this.menuColumn.innerWidth(),top:0}),this.editor.editorHeaderGroup.css({position:"fixed",top:0})):(this.menuColumn.css({position:"absolute",left:i.outerWidth()-this.menuColumn.innerWidth(),top:0}),this.editor.editorHeaderGroup.css({position:"absolute",top:0}));var o=this.menuContainer.offset().top-this.menuColumn.offset().top,s=t.height()-o,a=this.menuColumn.offset().top-e(window).scrollTop();return 0>a&&(a=0),s+o>e(window).height()&&(s=e(window).height()-o),s+o>t.height()+t.offset().top-e(window).scrollTop()&&(s=t.height()+t.offset().top-e(window).scrollTop()-o),this.menuContainer.css({"max-height":s}),this}},c.prototype.addNamespace=function(e,t){this.namespaceURIs[t]=e,this.namespaceToPrefix[e]=t},c.prototype.containsURI=function(e){return e in this.namespaceToPrefix},c.prototype.containsPrefix=function(e){return e in this.namespaceURIs},c.prototype.getNamespacePrefix=function(e){if(!e)return"";var t=this.namespaceToPrefix[e];return t&&(t+=":"),t},u.prototype.build=function(t,i,n){if(0==arguments.length&&(t=this.rootElement.ns+":"+this.rootElement.name,i=this.rootElement,n=null),"parents"in i)return void i.parents.push(n);i.parents=[n];var o=this.namespaceIndexes[i.ns];i.namespace=o.uri,i.schema||(i.localName=i.name,i.name=(o.prefix?o.prefix+":":"")+i.localName);var s=this.nameToDef[t];null==s?this.nameToDef[t]=[i]:this.nameToDef[t].push(i);var a=this;i.attributes&&e.each(i.attributes,function(){if(this.localName)return!0;this.localName=this.name;var e=a.namespaceIndexes[this.ns];this.namespace=e.uri,this.name=(e.prefix?e.prefix+":":"")+this.localName}),e.each(i.elements,function(){a.build(this.ns+":"+this.name,this,i)})},u.prototype.getElementDefinition=function(t){var i=0;e.each(this.namespaceIndexes,function(){return this.uri==t.namespaceURI?!1:void i++});var n=i+":"+Z(t),o=this.nameToDef[n];if(null==o)return null;if(1==o.length)return o[0];for(index in o)if(this.pathMatches(t,o[index]))return o[index]},u.prototype.pathMatches=function(e,t){var i=e.parentNode instanceof Document,n=e.parentNode;for(index in t.parents){var o=t.parents[index];if(i){if(null==t.parents[index]||t.parents[index].schema)return!0}else if(o.localName==Z(n)&&o.namespace==n.namespaceURI){var s=this.pathMatches(n,o);if(s)return!0}}return!1},m.prototype.resetSelectedTagRange=function(){return this.selectedTagRange={row:0,startColumn:0,endColumn:0},this},m.prototype.initialize=function(t){this.xmlContent=e("<div/>").attr({id:J+this.editor.instanceNumber,"class":J}).appendTo(t),this.xmlEditorDiv=e("<div/>").attr("id","text_editor").appendTo(this.xmlContent),this.aceEditor=ace.edit("text_editor"),this.aceEditor.setTheme("ace/theme/textmate"),this.aceEditor.getSession().setMode("ace/mode/xml"),this.aceEditor.setShowPrintMargin(!1),this.aceEditor.getSession().setUseSoftTabs(!0);var i=this;return this.aceEditor.getSession().on("change",function(){i.editor.isTextAreaEditor&&i.editor.setTextArea(i.aceEditor.getSession().getValue()),!i.editor.xmlState.changesNotSynced()&&i.isPopulated()&&(i.editor.xmlState.unsyncedChangeEvent(),i.setModified())}),this.aceEditor.getSession().selection.on("changeCursor",function(){i.selectTagAtCursor()}),this.setInitialized(),this},m.prototype.activate=function(){return this.active=!0,this.isInitialized()||this.initialize(this.editor.xmlTabContainer),this.xmlContent.show(),this.refreshDisplay(),this.resize(),this},m.prototype.deactivate=function(){return this.xmlContent.hide(),this.active=!1,this.editor.modifyMenu.clearContextualMenus(),this.isInitialized()&&this.setInitialized(),this},m.prototype.isInitialized=function(){return this.state>0},m.prototype.isPopulated=function(){return this.state>1},m.prototype.isModified=function(){return this.state>2},m.prototype.setInitialized=function(){return this.state=1,this},m.prototype.setPopulated=function(){return this.state=2,this},m.prototype.setModified=function(){return this.state=3,this},m.prototype.inSelectedTag=function(e,t,i){return!this.editor.xmlState.changesNotSynced()&&e==this.selectedTagRange.row&&t==this.selectedTagRange.startColumn&&i==this.selectedTagRange.endColumn},m.prototype.reload=function(){this.setInitialized(),this.selectedTagRange={row:0,startColumn:0,endColumn:0};var e=this.aceEditor.selection.getCursor();return this.aceEditor.getSession().setValue(this.editor.xml2Str(this.editor.xmlState.xml)),this.setPopulated(),this.aceEditor.focus(),this.aceEditor.selection.moveCursorToPosition(e),this},m.prototype.refreshDisplay=function(){this.editor.guiEditor.rootElement.xmlNode=this.editor.xmlState.xml.children().first();var t=this.aceEditor.session.getMarkers(),i=this;e.each(t,function(e){i.aceEditor.session.removeMarker(e)}),this.setInitialized();var n=this.editor.xml2Str(this.editor.xmlState.xml);try{this.aceEditor.getSession().setValue(n)}catch(o){alert(o)}return this.aceEditor.clearSelection(),this.setPopulated(),this.selectTagAtCursor(),this},m.prototype.resize=function(){var t=e(window).height()-this.xmlEditorDiv.offset().top;return this.xmlContent.css({height:t+"px"}),this.xmlEditorDiv.width(this.xmlContent.innerWidth()),this.xmlEditorDiv.height(t),null!=this.editor.modifyMenu.menuContainer&&this.editor.modifyMenu.menuContainer.css({"max-height":e(this.editor.xmlWorkAreaContainer).height()-this.editor.modifyMenu.menuContainer.offset().top}),null!=this.aceEditor&&this.aceEditor.resize(),this},m.prototype.tagOccurrences=function(e,t){if(null==e||null==t)return 0;var i=e.match(new RegExp("<"+t+"( |>|$)","g"));return i?i.length:0},m.prototype.selectTagAtCursor=function(){if(!this.isInitialized())return this;var t=this.aceEditor.getSession().getDocument().getLine(this.aceEditor.selection.getCursor().row),i=t.lastIndexOf("<",this.aceEditor.selection.getCursor().column),n=t.lastIndexOf(">",this.aceEditor.selection.getCursor().column);if(n>=i)return this;var o=this.aceEditor.selection.getCursor().row,s=t.indexOf(">",this.aceEditor.selection.getCursor().column);-1==s&&(s=t.length-1);var a=this.tagRegex.exec(t.substring(i));if(null!=a&&!this.inSelectedTag(o,i,s)){var r=a[1],d=a[2],l=a[3];d=d?d.substring(0,d.length-1):"";var h=this.editor.xmlState.namespaces.namespaceURIs[d];if(this.editor.xmlState.changesNotSynced())try{this.editor.setXMLFromEditor(),this.editor.xmlState.syncedChangeEvent()}catch(c){return this}var u=require("ace/range").Range,m=new u(0,0,this.aceEditor.selection.getCursor().row,i),p=this.aceEditor.getSession().getDocument().getTextRange(m),f=this,x=this.tagOccurrences(p,r),b=this.editor.xmlState.xml[0].getElementsByTagName(r)[x];if(b||(b=e(l,this.editor.xmlState.xml).filter(function(){return this.namespaceURI==h})[x]),!b)return this;var g=this.editor.schemaTree.getElementDefinition(b);if(null==g||g===this.editor.schemaTree.rootElement)return this.editor.modifyMenu.clearContextualMenus(),this;var y=null;try{y=new v(b,g,this.editor)}catch(c){return this}this.editor.modifyMenu.refreshContextualMenus(y).setMenuPosition(),
    this.selectedTagRange.row=o,this.selectedTagRange.startColumn=i,this.selectedTagRange.endColumn=s;var u=require("ace/range").Range,C=this.aceEditor.session.getMarkers();e.each(C,function(e){f.aceEditor.session.removeMarker(e)}),this.aceEditor.session.addMarker(new u(this.selectedTagRange.row,this.selectedTagRange.startColumn,this.selectedTagRange.row,this.selectedTagRange.endColumn+1),"highlighted","line",!1)}return this},m.prototype.addElementEvent=function(e,t){this.reload();var i=0,n=this.editor.xmlState.getNamespacePrefix(t.objectType.namespace),o=n.replace(":","\\:")+t.objectType.localName;this.editor.xmlState.xml.find(o).each(function(){return this===t.xmlNode.get(0)?!1:void i++});var s=require("ace/range").Range,a=new s(0,0,0,0),r=new RegExp("<("+this.editor.options.targetPrefix+":)?"+Z(t.xmlNode[0])+"(\\s|\\/|>|$)","g");this.aceEditor.find(r,{regExp:!0,start:a,wrap:!1});for(var d=0;i>d;d++)this.aceEditor.findNext({needle:r});this.aceEditor.clearSelection(),this.aceEditor.selection.moveCursorBy(0,-1*Z(t.xmlNode[0]).length),this.editor.xmlState.syncedChangeEvent()},m.prototype.addAttributeEvent=function(){this.reload(),this.editor.xmlState.syncedChangeEvent()},p.prototype.setStateChangeEvent=function(e){return this.stateChangeEvent=e,this},p.prototype.setStateCaptureEvent=function(e){return this.stateCaptureEvent=e,this},p.prototype.cloneNewDocument=function(t){if(!this.disabled){var i=t.implementation.createDocument(t.namespaceURI,null,null),n=i.importNode(t.documentElement,!0);return i.appendChild(n),e(i)}},p.prototype.changeHead=function(e){this.disabled||0>e&&this.headIndex+e<0||e>0&&this.headIndex+e>=this.states.length||this.headIndex+e>=this.editor.options.undoHistorySize||(this.headIndex+=e,this.xmlState.xml=this.cloneNewDocument(this.states[this.headIndex][0]),null!=this.stateChangeEvent&&this.stateChangeEvent(this))},p.prototype.captureSnapshot=function(){this.disabled||this.editor.options.undoHistorySize<=0||(this.headIndex<this.states.length-1&&(this.states=this.states.slice(0,this.headIndex+1)),this.states.length>=this.editor.options.undoHistorySize&&(this.states=this.states.slice(1,this.states.length)),this.headIndex=this.states.length,this.states.push(this.cloneNewDocument(this.xmlState.xml[0])),null!=this.stateCaptureEvent&&this.stateCaptureEvent(this))},f.prototype.constructor=f,f.prototype=Object.create(t.prototype),f.prototype.render=function(){if(this.xmlElement.domNode){this.domNodeID=this.xmlElement.domNodeID+"_"+this.objectType.ns+"_"+this.objectType.localName,this.domNode=e("<div/>").attr({id:this.domNodeID+"_cont","class":H}).data("xmlAttribute",this).appendTo(this.xmlElement.getAttributeContainer());var t=document.createElement("a");t.appendChild(document.createTextNode("(x) ")),this.domNode[0].appendChild(t);var i=document.createElement("label"),n=this.editor.xmlState.namespaces.getNamespacePrefix(this.objectType.namespace);i.appendChild(document.createTextNode(n+this.objectType.localName)),this.domNode[0].appendChild(i);var o=this.xmlElement.xmlNode.attr(this.attributeName);return""==o&&null!=this.objectType.defaultValue&&(o=this.objectType.defaultValue),this.attributeInput=this.createElementInput(this.domNodeID.replace(":","-"),o,this.domNode[0]),this.attributeInput.data("xmlAttribute",this),this.attributeInput}},f.prototype.remove=function(){e("#"+this.domNodeID).length>0&&null!=this.addButton&&this.addButton.removeClass("disabled"),this.xmlElement.removeAttribute(this.objectType),this.domNode.remove()},f.prototype.syncValue=function(){this.xmlElement.xmlNode.attr(this.attributeName,this.attributeInput.val())},f.prototype.changeValue=function(e){this.xmlElement.xmlNode.attr(this.attributeName,e)},f.prototype.select=function(){this.editor.guiEditor.selectNode(this.xmlElement),this.domNode.addClass("selected"),this.attributeInput.focus()},f.prototype.deselect=function(){this.domNode.removeClass("selected")},x.prototype.render=function(){this.domNodeID="attr_stub_"+this.guiEditor.nextIndex(),this.domNode=e("<div/>").attr({id:this.domNodeID+"_cont","class":H+" xml_attr_stub"}).data("xmlAttribute",this).appendTo(this.xmlElement.getAttributeContainer());var t=this,i=document.createElement("a");i.appendChild(document.createTextNode("(x) ")),this.domNode[0].appendChild(i),this.nameInput=document.createElement("label"),this.nameInput.className="edit_title",this.nameInput.setAttribute("contenteditable","true"),this.domNode[0].appendChild(this.nameInput),this.nameInput=e(this.nameInput);e("<span class='create_attr'>create attribute</span>").appendTo(this.domNode).mouseup(function(e){t.create()});return C.call(this,this.nameInput,this.xmlElement.objectType.attributes,e.proxy(this.xmlElement.attributeExists,this.xmlElement)),this.domNode},x.prototype.remove=function(){this.domNode.remove()},x.prototype.create=function(){var e=this.nameInput.text(),i=this.editor.addAttribute(this.xmlElement,e);i instanceof t?this.remove():console.log(i)},x.prototype.select=function(){this.domNode.addClass("selected")},x.prototype.deselect=function(){this.domNode.removeClass("selected")},x.prototype.isSelected=function(){return this.domNode.hasClass("selected")},x.prototype.focus=function(){this.nameInput.focus()},e.widget("custom.xml_autocomplete",e.ui.autocomplete,{messages:{noResults:"",results:function(){}},_create:function(){this._super(),this.menu.element.addClass("xml_autocomplete")},_resizeMenu:function(){var e=this.options.matchSize.outerWidth();this.menu.element.outerWidth(e)},_renderMenu:function(t,i){var n=this,o=this.options.validItemFunction,s=[];return e.each(i,function(e,t){return o&&o(t.value)?!0:void s.push([t.value.toLowerCase().indexOf(n.term.toLowerCase()),t])}),0==s.length?void this.close():(s.sort(function(e,t){return e[0]-t[0]}),void e.each(s,function(e,i){n._renderItemData(t,i[1])}))},_renderItem:function(t,i){var n=new RegExp("(("+this.term+")+)"),o=i.label.replace(n,"<span>$1</span>");return e("<li></li>").data("item.autocomplete",i).append("<a>"+o+"</a>").appendTo(t)},_move:function(e,t){this._super(e,t),this._resizeMenu()}}),b.prototype.constructor=b,b.prototype=Object.create(E.prototype),b.prototype.addXmlNode=function(t){var i="";if(this.textNode)i=this.textNode.nodeValue;else{var n=this.parentElement.xmlNode;this.textNode=n[0].ownerDocument.createCDATASection(""),t?n.prepend(this.textNode):n[0].appendChild(this.textNode),this.xmlNode=e(this.textNode)}return i},b.prototype.render=function(t,i){E.prototype.render.call(this,t,i),this.domNode.addClass("xml_cdata_node");var n=document.createElement("label");n.className="xml_type_header",n.appendChild(document.createTextNode("CDATA")),e(n).attr("for",this.domNodeID+"_text"),this.domNode.children(".xml_input_column").prepend(n)},b.prototype.syncText=function(){E.prototype.syncText.call(this)},b.prototype.remove=function(){t.prototype.remove.call(this)},b.prototype.select=function(){E.prototype.select.call(this)},b.prototype.swap=function(e){t.prototype.swap.call(this,e)},b.prototype.moveUp=function(){t.prototype.moveUp.call(this)},b.prototype.moveDown=function(){t.prototype.moveDown.call(this)},b.prototype.focus=function(){t.prototype.focus.call(this)},b.prototype.isSelected=function(){return t.prototype.isSelected.call(this)},g.prototype.constructor=g,g.prototype=Object.create(E.prototype),g.prototype.addXmlNode=function(t){var i="";if(this.textNode)i=this.textNode.nodeValue;else{var n=this.parentElement.xmlNode;this.textNode=n[0].ownerDocument.createComment(""),t?n.prepend(this.textNode):n[0].appendChild(this.textNode),this.xmlNode=e(this.textNode)}return i},g.prototype.render=function(t,i){E.prototype.render.call(this,t,i),this.domNode.addClass("xml_comment_node");var n=document.createElement("label");n.className="xml_type_header",n.appendChild(document.createTextNode("comment")),e(n).attr("for",this.domNodeID+"_text"),this.domNode.children(".xml_input_column").prepend(n)},g.prototype.syncText=function(){E.prototype.syncText.call(this)},g.prototype.remove=function(){t.prototype.remove.call(this)},g.prototype.select=function(){E.prototype.select.call(this)},g.prototype.swap=function(e){t.prototype.swap.call(this,e)},g.prototype.moveUp=function(){t.prototype.moveUp.call(this)},g.prototype.moveDown=function(){t.prototype.moveDown.call(this)},g.prototype.focus=function(){t.prototype.focus.call(this)},g.prototype.isSelected=function(){return t.prototype.isSelected.call(this)},v.prototype.constructor=v,v.prototype=Object.create(t.prototype),v.prototype.render=function(t,i,n,o){this.parentElement=t,this.domNodeID=this.guiEditor.nextIndex(),this.domElement=document.createElement("div"),this.domNode=e(this.domElement),this.domElement.id=this.domNodeID,this.domElement.className=this.objectType.localName+"_"+this.objectType.ns+"Instance "+D+" "+A,this.isTopLevel&&(this.domElement.className+=" "+P),this.isRootElement&&(this.domElement.className+=" xml_root_element"),this.insertDOMNode(n,o),this.elementHeader=document.createElement("ul"),this.elementHeader.className="element_header",this.domElement.appendChild(this.elementHeader);var s=document.createElement("li");s.className="element_name",this.elementHeader.appendChild(s),this.objectType.schema?this.elementName=this.xmlNode[0].tagName:this.elementName=this.editor.xmlState.getNamespacePrefix(this.objectType.namespace)+this.objectType.localName;var a=document.createElement("span");return a.appendChild(document.createTextNode(this.elementName)),s.appendChild(a),this.domNode.data("xmlObject",this),this.addContentContainers(i),this.isRootElement||this.elementHeader.appendChild(this.addTopActions(this.domNodeID)),this.initializeGUI(),this.updated({action:"render"}),this.domNode},v.prototype.insertDOMNode=function(e,t){this.parentElement&&(e?t?this.domNode.insertBefore(e.domNode):this.domNode.insertAfter(e.domNode):t?this.parentElement.nodeContainer.prepend(this.domNode):this.parentElement.nodeContainer[0].appendChild(this.domElement))},v.prototype.renderAttributes=function(){var t=this,i=this.objectType.attributes;i&&e(this.xmlNode[0].attributes).each(function(){for(var e=this.namespaceURI?this.namespaceURI:t.objectType.namespace,n=t.editor.stripPrefix(this.nodeName),o=0;o<i.length;o++)if(i[o].localName==n&&i[o].namespace==e){var s=new f(i[o],t,t.editor);return void s.render()}})},v.prototype.addChildrenCount=function(e){this.updateChildrenCount(e,1)},v.prototype.childRemoved=function(e){this.updateChildrenCount(e,-1)},v.prototype.updateChildrenCount=function(t,i){var n=this;this.nodeCount+=i;var o=t.objectType.ns+":"+t.objectType.localName,s=n.objectType.choices;if(n.presentChildren[o]?n.presentChildren[o]+=i:n.presentChildren[o]=i>0?i:0,s)for(var a=0;a<s.length;a++)e.inArray(o,s[a].elements)>-1&&(n.choiceCount[a]?n.choiceCount[a]+=i:n.choiceCount[a]=i>0?i:0)},v.prototype.childCanBeAdded=function(t){if(!this.allowChildren)return!1;if(!this.editor.options.enforceOccurs)return!0;var i=t.ns+":"+t.localName,n=this.presentChildren[i]||0,o=this.objectType.occurs&&i in this.objectType.occurs?this.objectType.occurs[i].max:"unbounded";if(null!=o&&"unbounded"!=o&&n>=o)return!1;var s=this.objectType.choices;if(s)for(var a=0;a<s.length;a++)if(e.inArray(i,s[a].elements)>-1){var r=this.choiceCount[a]||0;if(s[a].maxOccurs&&r>=s[a].maxOccurs)return!1}return!0},v.prototype.childCanBeRemoved=function(e){if(!this.editor.options.enforceOccurs)return!0;var t=e.ns+":"+e.localName;return this.presentChildren[t]&&this.objectType.occurs&&t in this.objectType.occurs?this.presentChildren[t]>this.objectType.occurs[t].min:!0},v.prototype.populateChildren=function(){if(this.editor.options.enforceOccurs){var t=this;e.each(this.objectType.elements,function(){var e=this.ns+":"+this.localName;if(t.objectType.occurs&&e in t.objectType.occurs){var i=t.objectType.occurs[e].min;if(i)for(var n=0;i>n;n++){var o=t.addElement(this);t.editor.activeEditor.addElementEvent(t,o)}}})}},v.prototype.initializeGUI=function(){var t=this;null!=this.nodeContainer&&this.nodeContainer.sortable({distance:10,items:"> ."+D,update:function(i,n){t.editor.guiEditor.updateElementPosition(e(n.item))}})},v.prototype.addTopActions=function(){var e=document.createElement("li");e.className="top_actions",this.toggleCollapse=document.createElement("span"),this.toggleCollapse.className="toggle_collapse",this.toggleCollapse.id=this.guiElementID+"_toggle_collapse",this.toggleCollapse.appendChild(document.createTextNode("_")),e.appendChild(this.toggleCollapse);var t=document.createElement("span");t.className="move_down",t.id=this.domNodeID+"_down",t.appendChild(document.createTextNode("")),e.appendChild(t);var i=document.createElement("span");i.className="move_up",i.id=this.domNodeID+"_up",i.appendChild(document.createTextNode("")),e.appendChild(i);var n=document.createElement("span");return n.className="xml_delete",n.id=this.domNodeID+"_del",n.appendChild(document.createTextNode("X")),e.appendChild(n),e},v.prototype.addContentContainers=function(t){var i=this.objectType.attributes;this.objectType.elements;this.contentContainer=document.createElement("div"),this.domElement.appendChild(this.contentContainer);var n=document.createElement("div");n.className="placeholder",this.allowText?this.allowAttributes?this.allowChildren?n.appendChild(document.createTextNode("Use the menu to add subelements, attributes and text.")):n.appendChild(document.createTextNode("Use the menu to add attributes and text.")):this.allowChildren?n.appendChild(document.createTextNode("Use the menu to add subelements and text.")):n.appendChild(document.createTextNode("Use the menu to add text.")):this.allowAttributes?this.allowChildren?n.appendChild(document.createTextNode("Use the menu to add subelements and attributes.")):n.appendChild(document.createTextNode("Use the menu to add attributes.")):this.allowChildren&&n.appendChild(document.createTextNode("Use the menu to add subelements.")),this.contentContainer.appendChild(n),this.placeholder=e(n),i&&i.length>0&&this.addAttributeContainer(),this.addNodeContainer(t)},v.prototype.addNodeContainer=function(t){var i=document.createElement("div");i.id=this.domNodeID+"_cont_nodes",i.className="content_block xml_children",this.nodeContainer=e(i),this.contentContainer.appendChild(i),this.nodeCount=0;var n=(this.xmlNode[0].children&&this.xmlNode[0].children.length>0,this.xmlNode[0].childNodes);for(var o in n){var s=n[o];switch(s.nodeType){case 1:this.renderChild(s,t);break;case 3:this.allowText&&s.nodeValue.trim()&&this.renderText(s);break;case 4:this.renderCData(s);break;case 8:this.renderComment(s)}}!this.allowText||0!=this.nodeCount||"mixed"==this.objectType.type&&this.objectType.any||this.renderText()},v.prototype.renderChild=function(t,i){var n=this.objectType.elements;if(n)for(var o=0;o<n.length;o++){var s=this.editor.xmlState.getNamespacePrefix(n[o].namespace);if(s+n[o].localName==t.nodeName){var a=new v(e(t),n[o],this.editor);return a.render(this,i),void this.addChildrenCount(a)}}var a=new T(e(t),this.editor);a.render(this,i),this.addChildrenCount(a)},v.prototype.renderText=function(e,t){var i=this.editor.getVocabulary(this),n=new E(e,this.objectType.type,this.editor,i);return n.render(this,t),this.nodeCount++,n},v.prototype.getTextInputs=function(){for(var t=this.nodeContainer.children("."+j),i=[],n=0;n<t.length;n++){var o=t.eq(n),s=o.data("xmlObject");i.push(s.textInput)}return e(i)},v.prototype.renderCData=function(e,t){var i=new b(e,this.editor);return i.render(this,t),this.nodeCount++,i},v.prototype.renderComment=function(e,t){var i=new g(e,this.editor);return i.render(this,t),this.nodeCount++,i},v.prototype.renderElementStub=function(e,t){var i=new y(this.editor);return i.render(this,e,t),this.nodeCount++,i},v.prototype.renderAttributeStub=function(){var e=new x(this,this.editor);return e.render(),this.attributeCount++,e},v.prototype.addAttributeContainer=function(){var t=document.createElement("div");t.id=this.domNodeID+"_cont_attributes",t.className="content_block "+R,this.contentContainer.appendChild(t),this.attributeContainer=e(t),this.renderAttributes()},v.prototype.addNonschemaElement=function(e,t,i){var n,o=this.editor.xmlState.xml[0];try{n=o.createElement(e)}catch(s){return null}this.insertXMLNode(n,t,i);var a=new T(n,this.editor);return this.addChildrenCount(a),null!=this.domNode&&a.render(this,!0,t,i),a},v.prototype.addElement=function(e,t,i){var n=this.editor.xmlState.getNamespacePrefix(e.namespace),o=this.editor.xmlState.xml[0],s=null;e.values&&e.values.length>0&&(s=e.values[0]);var a;if(o.createElementNS)a=o.createElementNS(e.namespace,n+e.localName);else{if("undefined"==typeof o.createNode)throw new Exception("Unable to add child due to incompatible browser");a=o.createNode(1,n+e.localName,e.namespace)}s&&a.appendChild(o.createTextNode(s)),this.insertXMLNode(a,t,i);var r=new v(a,e,this.editor);return this.addChildrenCount(r),null!=this.domNode&&r.render(this,!0,t,i),r.populateChildren(),r},v.prototype.insertXMLNode=function(t,i,n){if(i)if(i instanceof y){var o=this.domNode.nextAll(".xml_node:not(.xml_stub)");o.length>0?e(t).insertBefore(o.first().data("xmlObject").xmlNode):this.xmlNode[0].appendChild(t)}else n?e(t).insertBefore(i.xmlNode):e(t).insertAfter(i.xmlNode);else n?this.xmlNode.prepend(t):this.xmlNode[0].appendChild(t)},v.prototype.addAttribute=function(e){if(this.attributeExists(e))return null;var t="";e.defaultValue?t=e.defaultValue:e.values&&e.values.length>0&&(t=e.values[0]);var i,n=this.xmlNode[0],o=e.localName;e.namespace!=this.objectType.namespace&&(i=this.editor.xmlState.getNamespacePrefix(e.namespace),o=i+o),n.setAttributeNS&&i?n.setAttributeNS(e.namespace,o,t):this.xmlNode.attr(o,t);var s=new f(e,this,this.editor);return s.render(),s},v.prototype.attributeExists=function(t){var i;return i="string"==e.type(t)?t:t.namespace!=this.objectType.namespace?this.editor.xmlState.getNamespacePrefix(t.namespace)+t.localName:t.localName,i=this.xmlNode.attr(i),"undefined"!=typeof i&&i!==!1},v.prototype.addNode=function(e,t,i){switch(this.nodeContainer.show(),this.attributeContainer&&this.attributeContainer.show(),e){case"text":return this.allowText?this.renderText(null,t,i):null;case"cdata":return this.renderCData(null,t,i);case"comment":return this.renderComment(null,t,i);case"element":return this.allowChildren?this.renderElementStub(t,i):null;case"attribute":return this.allowAttributes?this.renderAttributeStub():null}return null},v.prototype.removeAttribute=function(e){var t=this.xmlNode[0],i=e.localName,n=t.hasAttributeNS(e.namespace,i);if(n){var o=e.name.split(":");t.removeAttributeNS(e.namespace,i),t.removeAttribute("xmlns:"+o[0])}else t.removeAttribute(i)},v.prototype.getSelectedAttribute=function(){return this.attributeContainer?this.attributeContainer.children(".selected"):[]},v.prototype.updated=function(e){null!=this.domNode&&(this.nodeCount=0,this.attributeCount=0,null!=this.nodeContainer&&(this.nodeCount=this.nodeContainer.children("."+A).length+this.nodeContainer.children("."+j).length,this.nodeCount>0?this.nodeContainer.show():this.nodeContainer.hide()),null!=this.attributeContainer&&(this.attributeCount=this.attributeContainer[0].children.length,this.attributeCount>0?this.attributeContainer.show():this.attributeContainer.hide()),0==this.nodeCount&&0==this.attributeCount?this.placeholder.show():this.placeholder.hide(),this.editor.options.elementUpdated&&this.editor.options.elementUpdated.call(this,e))},v.prototype.getAttributeContainer=function(){return this.attributeContainer},v.prototype.getChildContainer=function(){return this.childContainer},v.prototype.toggleCollapsed=function(){var t=this.domNode.hasClass("collapsed"),i=e(this.contentContainer),n=e(this.toggleCollapse),o=this;t?(n.html("_"),i.slideDown(150),o.domNode.removeClass("collapsed")):(n.html("+"),i.slideUp(150,function(){o.domNode.addClass("collapsed")}))},y.prototype.render=function(t,i,n){this.parentElement=t,this.domNodeID=this.guiEditor.nextIndex(),this.domNode=document.createElement("div");var o=e(this.domNode);this.domNode.id=this.domNodeID,this.domNode.className="xml_node xml_stub "+A,this.isTopLevel&&(this.domNode.className+=" "+P),this.parentElement&&(n?i?o.insertBefore(n.domNode):o.insertAfter(n.domNode):i?this.parentElement.nodeContainer.prepend(this.domNode):this.parentElement.nodeContainer[0].appendChild(this.domNode)),this.elementHeader=document.createElement("ul"),this.elementHeader.className="element_header",this.domNode.appendChild(this.elementHeader);var s=document.createElement("li");s.className="element_name",this.elementHeader.appendChild(s),this.nameInput=e("<span contenteditable='true' class='edit_title'/>"),this.nameInput.appendTo(s);var a=this;e("<span class='create_element'>create element</span>").appendTo(s).mouseup(function(e){a.create()});this.elementHeader.appendChild(this.addTopActions(this.domNodeID)),this.domNode=o,this.domNode.data("xmlObject",this),C.call(this,this.nameInput,t.objectType.elements)},y.prototype.addTopActions=function(){var e=document.createElement("li");e.className="top_actions";var t=document.createElement("span");return t.className="xml_delete",t.id=this.domNodeID+"_del",t.appendChild(document.createTextNode("X")),e.appendChild(t),e},y.prototype.remove=function(){this.domNode.remove()},y.prototype.create=function(){var e=this.nameInput.text(),i=this.domNode.nextAll(".xml_node:not(.xml_stub)"),n=null;i.length>0&&(n=i.first().data("xmlObject"));var o=this.editor.addChildElement(this.parentElement,e,n,null!=n);o instanceof t?(o.domNode.detach(),this.domNode.after(o.domNode),this.remove(),this.guiEditor.focusSelectedText(o)):console.log(o)},y.prototype.getSelectedAttribute=function(){return[]},y.prototype.select=function(){this.domNode.addClass("selected")},y.prototype.isSelected=function(){return this.domNode.hasClass("selected")},y.prototype.focus=function(){this.nameInput.focus()},N.prototype.constructor=N,N.prototype.createChooseTemplate=function(){this.templateForm(),this.createDialog(),this.loadEvents()},N.prototype.createDialog=function(){var t=this,i={};t.editor.options.templateOptions.cancelFunction&&(i.Cancel=e.proxy(t.editor.options.templateOptions.cancelFunction,t)),i.Choose=function(){t.processForm()},this.form.dialog({autoOpen:!0,dialogClass:"jquery-editor-no-close template-form",height:350,width:500,modal:!0,buttons:i})},N.prototype.templateForm=function(){for(var t='<div class="template-form" title="Choose Template"><ul>',i=0;i<this.templates.length;i++){var n=this.templates[i];t+='<li class="templating" id="template_'+i+'"><a href="'+n.filename+'">',n.icon_url&&(t+='<img class="'+n.icon_class+'" src="'+n.icon_url+'"/> '),n.icon_class&&(t+='<i class="'+n.icon_class+'"></i> '),t+="<div>",t+=n.title?n.title:n.filename,n.description&&(t+="<span>"+n.description+"</span>"),t+="</div>",t+="</a></li>"}t+="</ul></div>",this.form=e(t),this.form.insertAfter("body"),e("li:first",this.form).addClass("focus")},N.prototype.processForm=function(){var t=e(".focus a",this.form).attr("href");this.form.dialog("close"),this.loadSelectedTemplate(t)},N.prototype.loadSelectedTemplate=function(t){var i=this;e.ajax({url:this.template_path+t,dataType:"xml"}).done(function(e){var t=i.editor.xml2Str(e);i.editor._documentReady(t)}).fail(function(e,t){alert("Unable to load the requested template: "+t)})},N.prototype.focusTemplate=function(){var t=this;this.form.on("keydown click",".templating",function(i){var n,o,s,a,r,d=i.which;(1===d||9===d)&&(i.preventDefault(),n=e(".templating").length,1==d?(o=e(i.target),o.hasClass("templating")||(o=o.parent(".templating"))):(s=e(".focus",t.form).attr("id"),a=parseInt(s.slice(-1))+1,r=a===n?0:a,o=e("#template_"+r)),e(".templating",t.form).removeClass("focus"),o.addClass("focus").focus()),(13==d||27==d)&&t.processForm()})},N.prototype.loadEvents=function(e){var t=this;this.focusTemplate(),this.form.on("dblclick",function(){t.processForm()})},E.prototype.constructor=E,E.prototype=Object.create(t.prototype),E.prototype.syncText=function(){this.textNode.nodeValue=this.textInput.val()},E.prototype.select=function(){e(".selected").removeClass("selected"),this.domNode.closest("."+A).addClass("selected"),this.domNode.addClass("selected")},E.prototype.addXmlNode=function(t){var i="";return this.textNode?i=this.textNode.nodeValue:(this.textNode=document.createTextNode(""),t?this.parentElement.xmlNode.prepend(this.textNode):this.parentElement.xmlNode[0].appendChild(this.textNode),this.xmlNode=e(this.textNode)),i},E.prototype.render=function(i,n){this.parentElement=i,this.domNodeID=this.guiEditor.nextIndex(),this.domNode=document.createElement("div");var o=e(this.domNode);this.domNode.id=this.domNodeID,this.domNode.className=D+" "+j,n?this.parentElement.nodeContainer.prepend(this.domNode):this.parentElement.nodeContainer[0].appendChild(this.domNode);var s=document.createElement("div");s.className="xml_input_column",this.domNode.appendChild(s);var a=this.addXmlNode(n);return this.textInput=t.prototype.createElementInput.call(this,this.domNodeID+"_text",a,s),this.textInput.addClass("element_text"),this.vocabulary&&this.vocabulary.values&&this.textInput.autocomplete({source:this.vocabulary.values}),this.deleteButton=document.createElement("div"),this.deleteButton.className="xml_delete",this.deleteButton.appendChild(document.createTextNode("x")),this.domNode.appendChild(this.deleteButton),this.domNode=o,this.domNode.data("xmlObject",this),this.domNode},E.prototype.swap=function(e){t.prototype.swap.call(this,e)},E.prototype.moveUp=function(){t.prototype.moveUp.call(this)},E.prototype.moveDown=function(){t.prototype.moveDown.call(this)},E.prototype.focus=function(){t.prototype.focus.call(this)},E.prototype.isSelected=function(){return t.prototype.isSelected.call(this)},T.prototype.constructor=T,T.prototype=Object.create(v.prototype),T.prototype.render=function(t,i,n,o){this.parentElement=t,this.domNodeID=this.guiEditor.nextIndex(),this.domElement=document.createElement("div"),this.domNode=e(this.domElement),this.domElement.id=this.domNodeID,this.domElement.className="xml_node "+A,this.isTopLevel&&(this.domElement.className+=" "+P),this.isRootElement&&(this.domElement.className+=" xml_root_element"),this.insertDOMNode(n,o),this.elementHeader=document.createElement("ul"),this.elementHeader.className="element_header",this.domElement.appendChild(this.elementHeader);var s=document.createElement("li");s.className="element_name",this.elementHeader.appendChild(s),this.elementName=this.xmlNode[0].tagName;var a=document.createElement("span");return a.appendChild(document.createTextNode(this.elementName)),s.appendChild(a),this.domNode.data("xmlObject",this),this.addContentContainers(i),this.isRootElement||this.elementHeader.appendChild(this.addTopActions(this.domNodeID)),this.initializeGUI(),this.updated({action:"render"}),this.domNode},T.prototype.addContentContainers=function(t){this.objectType.attributes,this.objectType.elements;this.contentContainer=document.createElement("div"),this.domElement.appendChild(this.contentContainer);var i=document.createElement("div");i.className="placeholder",i.appendChild(document.createTextNode("Use the menu to add contents.")),this.contentContainer.appendChild(i),this.placeholder=e(i),this.addAttributeContainer(),this.addNodeContainer(t)},T.prototype.updateChildrenCount=function(e,t){this.nodeCount+=t},T.prototype.childCanBeRemoved=function(e){return!0}}(jQuery);